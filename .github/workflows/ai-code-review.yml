name: AI Code Review with Gemini 2.5

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop

permissions:
  pull-requests: write
  contents: read

jobs:
  gemini-review:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -q google-generativeai requests

      - name: Fetch PR diff and context
        id: pr-context
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
          git fetch origin ${{ github.base_ref }}
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD --no-color)
          
          # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å diff –≤ —Ñ–∞–π–ª
          echo "$DIFF" > /tmp/pr_diff.txt
          
          # –ü–æ–ª—É—á–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ PR
          PR_BODY=$(gh pr view ${{ github.event.number }} --json body -q .body)
          echo "PR_TITLE=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
          echo "PR_BODY<<EOF" >> $GITHUB_OUTPUT
          echo "$PR_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Gemini AI Code Review
        id: review
        env:
          GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
        run: |
          python3 << 'EOF'
          import os
          import json
          import google.generativeai as genai
          from pathlib import Path
          
          # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
          api_key = os.getenv("GOOGLE_AI_API_KEY")
          if not api_key:
              print("‚ùå GOOGLE_AI_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
              exit(1)
          
          genai.configure(api_key=api_key)
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å Gemini 2.5 Flash
          model = genai.GenerativeModel("gemini-2.5-flash")
          
          # –ß–∏—Ç–∞–µ–º diff
          with open("/tmp/pr_diff.txt", "r") as f:
              pr_diff = f.read()
          
          if not pr_diff.strip():
              print("‚ö†Ô∏è  –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏")
              exit(0)
          
          # Prompt –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
          review_prompt = f"""
          –¢—ã - –æ–ø—ã—Ç–Ω—ã–π –∫–æ–¥-—Ä–µ–≤—å—é–µ—Ä –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ Content Factory (Python, AI, video generation).
          
          –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ PR –∏ –ø—Ä–æ–≤–µ—Ä—å –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ:
          
          **–û–°–ù–û–í–ù–´–ï –ö–†–ò–¢–ï–†–ò–ò –ü–†–û–í–ï–†–ö–ò:**
          1. **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ** - –∫–æ–¥ —Å–ª–µ–¥—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º –∏–∑ ARCHITECTURE.md?
          2. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Gemini API** - –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ModelRouter –∏ google-generativeai?
             - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –º–æ–¥–µ–ª–∏ –¢–û–õ–¨–ö–û: gemini-2.5-flash, gemini-2.5-flash-lite, gemini-1.5-flash
             - gemini-2.0-flash DEPRECATED!
          3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - –µ—Å—Ç—å –ª–∏ proper exception handling –∏ retry logic?
          4. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏ config_loader –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º?
          5. **TTS –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ —Ä–∞–±–æ—Ç–µ —Å Edge-TTS?
          6. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å** - async/await –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ?
          7. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞?
          8. **–¢–µ—Å—Ç—ã** - –¥–æ–±–∞–≤–ª–µ–Ω—ã –ª–∏ unit tests –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞?
          
          **–ß–ê–°–¢–´–ï –û–®–ò–ë–ö–ò –í –ü–†–û–ï–ö–¢–ï:**
          - ‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ deprecated –º–æ–¥–µ–ª–µ–π (gemini-2.0-flash - –ë–û–õ–¨–®–ï –ù–ï –ü–û–î–î–ï–†–ñ–ò–í–ê–ï–¢–°–Ø!)
          - ‚ùå –ò–º–ø–æ—Ä—Ç –∏–∑ moviepy.video –≤–º–µ—Å—Ç–æ moviepy.editor
          - ‚ùå Hardcoded API keys (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å os.getenv())
          - ‚ùå –ü—Ä—è–º–æ–π try/except –±–µ–∑ —Ç–∏–ø–∞ exception
          - ‚ùå –ú—É—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
          - ‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ localStorage (—Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ, –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ GitHub Actions)
          - ‚ùå –ü—É—Å—Ç—ã–µ –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ YAML –∫–æ–Ω—Ñ–∏–≥–∏
          - ‚ùå –ó–∞–±—ã—Ç—ã–µ await –¥–ª—è async —Ñ—É–Ω–∫—Ü–∏–π
          
          **–ê–ö–¢–£–ê–õ–¨–ù–´–ï –ú–û–î–ï–õ–ò GEMINI (–Ω–∞ –¥–µ–∫–∞–±—Ä—å 2025):**
          ‚úÖ gemini-2.5-flash - –Ω–æ–≤–µ–π—à–∞—è, –±—ã—Å—Ç—Ä–∞—è, –¥–µ—à—ë–≤–∞—è (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)
          ‚úÖ gemini-2.5-flash-lite - –µ—â—ë –±—ã—Å—Ç—Ä–µ–µ –∏ –¥–µ—à–µ–≤–ª–µ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–¥–∞—á
          ‚úÖ gemini-1.5-flash - —Å—Ç–∞—Ä–∞—è –Ω–æ –≤—Å—ë –µ—â—ë –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
          ‚ùå gemini-2.0-flash - DEPRECATED, –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å!
          ‚ùå gemini-2.0-flash-exp - DEPRECATED, –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å!
          
          **PR DIFF –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê:**
          ```diff
          {pr_diff[:8000]}  # –õ–∏–º–∏—Ç –¥–ª—è —Ç–æ–∫–µ–Ω–æ–≤
          ```
          
          **–¢–†–ï–ë–£–ï–ú–´–ô –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (JSON):**
          {{
            "overall_rating": "‚úÖ APPROVE | ‚ö†Ô∏è  REVIEW | ‚ùå REQUEST_CHANGES",
            "summary": "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ",
            "issues": [
              {{
                "severity": "critical | warning | info",
                "file": "–ø—É—Ç—å/–∫/—Ñ–∞–π–ª—É.py",
                "line": 42,
                "message": "–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã",
                "suggestion": "–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å"
              }}
            ],
            "improvements": [
              "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 1",
              "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 2"
            ],
            "checklist": {{
              "architecture_compliant": true/false,
              "error_handling_ok": true/false,
              "tests_added": true/false,
              "no_security_issues": true/false,
              "correct_gemini_models": true/false
            }}
          }}
          
          –ë—É–¥—å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–µ–Ω –∏ —á–µ—Å—Ç–µ–Ω. –û—Ç–º–µ—Ç—å –∫–∞–∫ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ, —Ç–∞–∫ –∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã.
          """
          
          try:
              print("ü§ñ –ó–∞–ø—Ä–∞—à–∏–≤–∞—é –∞–Ω–∞–ª–∏–∑ —É Gemini 2.5 Flash...")
              response = model.generate_content(review_prompt)
              
              # –ü–∞—Ä—Å–∏–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
              text = response.text
              
              # –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å JSON
              import re
              json_match = re.search(r'\{.*\}', text, re.DOTALL)
              
              if json_match:
                  review_data = json.loads(json_match.group())
              else:
                  # Fallback –µ—Å–ª–∏ JSON –Ω–µ –Ω–∞–π–¥–µ–Ω
                  review_data = {
                      "overall_rating": "‚ö†Ô∏è  REVIEW",
                      "summary": text[:500],
                      "issues": [],
                      "improvements": [],
                      "checklist": {}
                  }
              
              # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
              with open("/tmp/review_result.json", "w") as f:
                  json.dump(review_data, f, ensure_ascii=False, indent=2)
              
              print("‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω!")
              print(f"üìä –†–µ–π—Ç–∏–Ω–≥: {review_data.get('overall_rating', 'N/A')}")
              
          except Exception as e:
              print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ Gemini: {str(e)}")
              exit(1)
          
          EOF

      - name: Post review as PR comment
        if: always()
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${{ github.token }}
        with:
          script: |
            const fs = require('fs');
            const path = '/tmp/review_result.json';
            
            if (!fs.existsSync(path)) {
              console.log("‚ùå Review result not found");
              return;
            }
            
            const review = JSON.parse(fs.readFileSync(path, 'utf8'));
            
            let comment = `## ü§ñ AI Code Review by Gemini 2.5 Flash\n\n`;
            comment += `**Overall Rating:** ${review.overall_rating || '‚ö†Ô∏è  REVIEW'}\n\n`;
            comment += `**Summary:** ${review.summary}\n\n`;
            
            if (review.issues && review.issues.length > 0) {
              comment += `### üö® Issues Found\n`;
              review.issues.forEach(issue => {
                const severity = issue.severity === 'critical' ? 'üî¥' : 
                                issue.severity === 'warning' ? 'üü°' : 'üîµ';
                comment += `\n${severity} **${issue.severity.toUpperCase()}** in \`${issue.file}:${issue.line}\`\n`;
                comment += `> ${issue.message}\n`;
                comment += `üí° ${issue.suggestion}\n`;
              });
            }
            
            if (review.improvements && review.improvements.length > 0) {
              comment += `\n### üí° Improvements Suggested\n`;
              review.improvements.forEach(imp => {
                comment += `- ${imp}\n`;
              });
            }
            
            if (review.checklist) {
              comment += `\n### ‚úÖ Checklist\n`;
              Object.entries(review.checklist).forEach(([key, value]) => {
                const icon = value ? '‚úÖ' : '‚ùå';
                comment += `${icon} ${key.replace(/_/g, ' ')}\n`;
              });
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Determine PR status
        if: always()
        run: |
          if [ -f "/tmp/review_result.json" ]; then
            RATING=$(grep -o '"overall_rating": "[^"]*' /tmp/review_result.json | cut -d'"' -f4)
            if [[ "$RATING" == *"REQUEST_CHANGES"* ]]; then
              echo "‚ùå Critical issues found"
              exit 1
            elif [[ "$RATING" == *"REVIEW"* ]]; then
              echo "‚ö†Ô∏è  Review needed"
              exit 0
            else
              echo "‚úÖ Changes approved"
              exit 0
            fi
          fi
