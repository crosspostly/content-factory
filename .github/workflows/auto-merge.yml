name: Auto-Merge (Successful Auto-Fix PRs)

# –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–≥–¥–∞ PR –ø–æ–ª—É—á–∞–µ—Ç label "auto-merge"
on:
  pull_request:
    types: [labeled, synchronize, opened]
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  pull-requests: write

jobs:
  check-ready-to-merge:
    name: Check if PR ready to merge
    runs-on: ubuntu-latest
    outputs:
      should-merge: ${{ steps.check.outputs.should-merge }}
      reason: ${{ steps.check.outputs.reason }}
    
    steps:
      - name: Check merge conditions
        id: check
        run: |
          # –£—Å–ª–æ–≤–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ merge:
          # 1. PR –∏–º–µ–µ—Ç label "auto-merge"
          # 2. PR –æ–¥–æ–±—Ä–µ–Ω (approved)
          # 3. –í—Å–µ checks pass
          # 4. PR —ç—Ç–æ –ù–ï draft
          
          LABELS="${{ github.event.pull_request.labels.*.name }}"
          IS_DRAFT="${{ github.event.pull_request.draft }}"
          
          if [[ "$LABELS" == *"auto-merge"* ]] && [[ "$IS_DRAFT" == "false" ]]; then
            echo "should-merge=true" >> $GITHUB_OUTPUT
            echo "reason=Has auto-merge label and is not draft" >> $GITHUB_OUTPUT
          else
            echo "should-merge=false" >> $GITHUB_OUTPUT
            if [[ "$IS_DRAFT" == "true" ]]; then
              echo "reason=PR is draft" >> $GITHUB_OUTPUT
            else
              echo "reason=Missing auto-merge label" >> $GITHUB_OUTPUT
            fi
          fi
  
  auto-merge:
    name: Auto Merge PR
    runs-on: ubuntu-latest
    needs: check-ready-to-merge
    if: needs.check-ready-to-merge.outputs.should-merge == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Merge PR
        run: |
          echo "üîÑ Merging PR #${{ github.event.pull_request.number }}"
          echo "Reason: ${{ needs.check-ready-to-merge.outputs.reason }}"
          
          gh pr merge ${{ github.event.pull_request.number }} \
            --auto \
            --squash \
            --delete-branch || echo "‚ö†Ô∏è Could not merge (may already be merged)"
        env:
          GH_TOKEN: ${{ github.token }}
        continue-on-error: true
      
      - name: Comment on PR
        if: always()
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "‚úÖ Auto-merged by GitHub Actions" || true
        env:
          GH_TOKEN: ${{ github.token }}
        continue-on-error: true
