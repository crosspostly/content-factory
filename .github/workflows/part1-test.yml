name: Part 1 MVP Test

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      mode:
        description: Generation mode
        required: true
        default: shorts
        type: choice
        options:
          - shorts
          - long_form
          - ad
      project:
        description: Project name
        required: true
        default: youtube_horoscope
      dry_run:
        description: Dry run (no upload)
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  test_part1:
    runs-on: ubuntu-22.04
    name: Generate Content (Part 1 MVP)
    continue-on-error: true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: pip
      
      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y ffmpeg imagemagick >/dev/null 2>&1
        continue-on-error: true
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        continue-on-error: true
      
      - name: Generate Content
        run: |
          if [ "$DRY_RUN" = "false" ]; then
            UPLOAD_FLAG="--upload"
          else
            UPLOAD_FLAG="--dry-run"
          fi
          python -m core.orchestrators.pipeline_orchestrator --project "$PROJECT" --mode "$MODE" $UPLOAD_FLAG
        env:
          PROJECT: ${{ github.event.inputs.project || 'youtube_horoscope' }}
          MODE: ${{ github.event.inputs.mode || 'shorts' }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'true' }}
          GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        continue-on-error: true

      
      - name: Check Output Artifacts
        if: always()
        run: |
          echo "Generated Scripts:"
          find output/scripts -name "*.json" 2>/dev/null | head -5 || echo "No scripts generated"
          echo ""
          echo "Generated Audio:"
          find output/audio -name "*.wav" 2>/dev/null | head -5 || echo "No audio generated"
          echo ""
          echo "Generated Videos:"
          find output/videos -name "*.mp4" 2>/dev/null | head -5 || echo "No videos generated"
        continue-on-error: true
      
      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: content-factory-output-${{ github.run_number }}
          path: |
            output/scripts/
            output/audio/
            output/videos/
            output/logs/
          retention-days: 7
        continue-on-error: true
      
      - name: Success Notification
        if: success()
        run: echo "Part 1 MVP Test PASSED!"
      
      - name: Failure Notification
        if: failure()
        run: echo "Part 1 MVP Test completed with issues"
