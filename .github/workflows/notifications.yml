name: Notifications & Alerts

on:
  workflow_run:
    workflows:
      - "Run Tests"
      - "AI Code Review with Gemini 2.5"
      - "Code Quality & Linting"
      - "Build Docker"
    types:
      - completed

jobs:
  notify:
    runs-on: ubuntu-latest
    name: Send Notifications
    if: always()
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Status
        id: status
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" = "success" ]; then
            echo "status=âœ… SUCCESS" >> $GITHUB_OUTPUT
            echo "emoji=ðŸŽ‰" >> $GITHUB_OUTPUT
            echo "color=2ecc71" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.workflow_run.conclusion }}" = "failure" ]; then
            echo "status=âŒ FAILED" >> $GITHUB_OUTPUT
            echo "emoji=ðŸ”´" >> $GITHUB_OUTPUT
            echo "color=e74c3c" >> $GITHUB_OUTPUT
          else
            echo "status=âš ï¸ CANCELLED" >> $GITHUB_OUTPUT
            echo "emoji=âš ï¸" >> $GITHUB_OUTPUT
            echo "color=f39c12" >> $GITHUB_OUTPUT
          fi

      - name: Send Telegram Notification
        uses: appleboy/telegram-action@master
        if: env.TELEGRAM_BOT_TOKEN != ''
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ${{ steps.status.outputs.emoji }} Workflow: ${{ github.event.workflow_run.name }}
            Status: ${{ steps.status.outputs.status }}
            
            Repository: ${{ github.repository }}
            Branch: ${{ github.event.workflow_run.head_branch }}
            Commit: ${{ github.event.workflow_run.head_commit.message }}
            Author: ${{ github.event.workflow_run.actor }}
            
            ðŸ”— Details: https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}
        continue-on-error: true

      - name: Send Telegram on Test Failure
        uses: appleboy/telegram-action@master
        if: github.event.workflow_run.name == 'Run Tests' && github.event.workflow_run.conclusion == 'failure' && env.TELEGRAM_BOT_TOKEN != ''
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ðŸ”´ TESTS FAILED!
            
            You need to fix these issues:
            - Check test logs in Actions tab
            - Run locally: pytest tests/ -v
            - Push fixes to fix the workflow
            
            ðŸ”— Action logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}
        continue-on-error: true

      - name: Download Artifacts
        if: github.event.workflow_run.conclusion == 'failure'
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
        continue-on-error: true

      - name: Setup Python
        if: github.event.workflow_run.conclusion == 'failure'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
        continue-on-error: true

      - name: Send to Gemini & Auto-Fix
        if: github.event.workflow_run.conclusion == 'failure' && env.GEMINI_API_KEY != ''
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
          COMMIT_MESSAGE: ${{ github.event.workflow_run.head_commit.message }}
          ACTOR: ${{ github.event.workflow_run.actor }}
        run: |
          python3 << 'EOF'
          import os
          import json
          import subprocess
          from pathlib import Path
          
          api_key = os.getenv('GEMINI_API_KEY')
          workflow_name = os.getenv('WORKFLOW_NAME')
          commit_msg = os.getenv('COMMIT_MESSAGE')
          actor = os.getenv('ACTOR')
          
          # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ
          error_context = {
              "workflow": workflow_name,
              "commit": commit_msg,
              "actor": actor,
              "repository": "${{ github.repository }}",
              "run_id": "${{ github.event.workflow_run.id }}",
              "branch": "${{ github.event.workflow_run.head_branch }}"
          }
          
          # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð»Ð¾Ð³Ð¸
          error_logs = []
          for artifact_dir in Path('.').glob('**/logs'):
              for log_file in artifact_dir.glob('*.log'):
                  try:
                      with open(log_file, 'r') as f:
                          error_logs.append(f.read()[:1000])  # ÐŸÐµÑ€Ð²Ñ‹Ðµ 1000 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²
                  except:
                      pass
          
          # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚ Ð´Ð»Ñ Gemini
          prompt = f"""
          ðŸ”´ WORKFLOW FAILURE ALERT
          
          Workflow: {workflow_name}
          Commit: {commit_msg}
          Author: {actor}
          Repository: ${{{{ github.repository }}}}
          Run: https://github.com/${{{{ github.repository }}}}/actions/runs/${{{{ github.event.workflow_run.id }}}}
          
          Error Logs:
          {json.dumps(error_logs, indent=2)}
          
          Please analyze this failure and suggest specific fixes. Be concise and actionable.
          """
          
          # ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð² Gemini
          import urllib.request
          import urllib.error
          
          try:
              url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key={api_key}"
              
              request_data = json.dumps({
                  "contents": [{
                      "parts": [{"text": prompt}]
                  }]
              }).encode('utf-8')
              
              req = urllib.request.Request(
                  url,
                  data=request_data,
                  headers={'Content-Type': 'application/json'}
              )
              
              with urllib.request.urlopen(req) as response:
                  result = json.loads(response.read().decode('utf-8'))
                  
                  if 'candidates' in result and result['candidates']:
                      gemini_response = result['candidates'][0]['content']['parts'][0]['text']
                      
                      # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¾Ñ‚Ð²ÐµÑ‚ Ð² Ñ„Ð°Ð¹Ð»
                      with open('gemini_analysis.md', 'w') as f:
                          f.write(f"# Gemini Analysis\n\n{gemini_response}")
                      
                      print(f"âœ… Gemini Analysis Saved")
                      print(f"\n{gemini_response}")
                  else:
                      print("âš ï¸ No response from Gemini")
          except urllib.error.HTTPError as e:
              print(f"âŒ Gemini API Error: {e.reason}")
              error_body = e.read().decode('utf-8')
              print(f"Error details: {error_body}")
          except Exception as e:
              print(f"âŒ Error: {str(e)}")
          
          EOF
        continue-on-error: true

      - name: Upload Gemini Analysis
        if: always() && hashFiles('gemini_analysis.md') != ''
        uses: actions/upload-artifact@v4
        with:
          name: gemini-analysis
          path: gemini_analysis.md
          retention-days: 7
        continue-on-error: true

      - name: Create Issue with Analysis
        if: github.event.workflow_run.conclusion == 'failure' && hashFiles('gemini_analysis.md') != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const analysis = fs.readFileSync('gemini_analysis.md', 'utf8');
            
            try {
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ”§ [AUTO-ANALYSIS] ${{ github.event.workflow_run.name }} - Fix Required`,
                body: `## Workflow Failure Analysis\n\nGenerated by Gemini AI\n\n${analysis}\n\n---\n\n**Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}\n**Workflow:** ${{ github.event.workflow_run.name }}\n**Commit:** ${{ github.event.workflow_run.head_commit.message }}\n**Author:** @${{ github.event.workflow_run.actor }}`,
                labels: ['ðŸ¤– auto-generated', 'bug', 'workflow-error'],
                assignee: '${{ github.event.workflow_run.actor }}'
              });
              console.log(`âœ… Issue created: #${issue.data.number}`);
            } catch (error) {
              console.log(`âš ï¸ Could not create issue: ${error.message}`);
            }
        continue-on-error: true
