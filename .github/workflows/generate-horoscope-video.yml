name: Generate Horoscope Video

on:
  workflow_dispatch:
    inputs:
      format:
        description: 'Video format (shorts | long-form | ad)'
        required: true
        default: 'shorts'
        type: choice
        options:
          - shorts
          - long-form
          - ad
      date:
        description: 'Horoscope date (YYYY-MM-DD, optional - uses today)'
        required: false
        type: string
      project:
        description: 'Project name'
        required: false
        default: 'youtube_horoscope'
        type: string
  
  schedule:
    - cron: '0 6 * * *'  # Daily 06:00 UTC = 09:00 MSK

jobs:
  generate-video:
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y ffmpeg imagemagick ghostscript fonts-dejavu-core libsm6 libxext6
          echo "âœ… System dependencies installed"
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -q
          echo "âœ… Python dependencies installed"
      
      - name: Determine format and date
        id: params
        run: |
          FORMAT="${{ github.event.inputs.format || 'shorts' }}"
          DATE="${{ github.event.inputs.date }}"
          PROJECT="${{ github.event.inputs.project || 'youtube_horoscope' }}"
          
          if [ -z "$DATE" ]; then
            DATE=$(date +%Y-%m-%d)
          fi
          
          echo "format=$FORMAT" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "project=$PROJECT" >> $GITHUB_OUTPUT
          
          echo "ðŸ“… Format: $FORMAT"
          echo "ðŸ“† Date: $DATE"
          echo "ðŸ“¦ Project: $PROJECT"
      
      - name: Generate Content (Script â†’ TTS â†’ Video with ModelRouter)
        id: generate
        env:
          GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
          PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY }}
          FORMAT: ${{ steps.params.outputs.format }}
          DATE: ${{ steps.params.outputs.date }}
          PROJECT: ${{ steps.params.outputs.project }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          import sys
          from pathlib import Path
          
          # Add current dir to path to import core modules
          sys.path.insert(0, '.')
          
          project_name = os.getenv('PROJECT')
          fmt = os.getenv('FORMAT')
          target_date = os.getenv('DATE')
          api_key = os.getenv('GOOGLE_AI_API_KEY')
          
          if not api_key:
              print("âŒ Error: GOOGLE_AI_API_KEY not set")
              sys.exit(1)
          
          print(f"\n" + "="*70)
          print(f"ðŸŽ¬ HOROSCOPE VIDEO GENERATION")
          print(f"="*70)
          print(f"Project: {project_name}")
          print(f"Format: {fmt}")
          print(f"Date: {target_date}\n")
          
          # ========== LOAD CONFIG =========="
          print(f"âš¡ Loading configuration...")
          try:
              from core.utils.config_loader import ProjectConfig
              config_path = f"projects/{project_name}/config.yaml"
              config = ProjectConfig.load(config_path)
              print(f"âœ… Config loaded: {config_path}")
          except Exception as e:
              print(f"âŒ Config loading failed: {e}")
              # Fallback config if file missing (for testing)
              from core.utils.config_loader import ProjectConfig
              config = ProjectConfig(
                  name=project_name, 
                  description="Fallback", 
                  content_type=fmt,
                  platforms=["youtube"]
              )
              print(f"âš ï¸ Using fallback config")

          # ========== PART 1: SCRIPT GENERATION =========="
          print(f"\nðŸ“ PART 1: Script Generation (with ModelRouter)")
          print(f"-" * 70)
          
          try:
              from core.generators import script_generator
              
              # UPDATED CALL: Passing config and api_key
              if fmt == "shorts":
                  script = script_generator.generate_short(
                      config=config, 
                      target_date=target_date, 
                      api_key=api_key
                  )
              elif fmt == "long_form":
                  script = script_generator.generate_long_form(
                      config=config, 
                      target_date=target_date, 
                      api_key=api_key
                  )
              elif fmt == "ad":
                  script = script_generator.generate_ad(
                      config=config, 
                      target_date=target_date, 
                      api_key=api_key
                  )
              else:
                  raise ValueError(f"Unknown format: {fmt}")
              
              print(f"âœ… Script generated")
              print(f"   Format: {fmt}")
              print(f"   Length: {len(script.get('script', ''))} chars")
          
          except Exception as e:
              print(f"âŒ Script generation failed: {e}")
              import traceback
              traceback.print_exc()
              sys.exit(1)
          
          # ========== PART 2: TTS SYNTHESIS =========="
          print(f"\nðŸŽ™ï¸ PART 2: TTS Synthesis")
          print(f"-" * 70)
          
          try:
              from core.generators import tts_generator
              
              audio_map = tts_generator.synthesize(
                  script=script,
                  mode=fmt,
                  api_key=api_key
              )
              
              print(f"âœ… Audio synthesized")
              print(f"   Duration: {audio_map.get('total_duration_sec', 0):.1f}s")
              print(f"   Blocks: {len(audio_map.get('blocks', {}))}")
          
          except Exception as e:
              print(f"âŒ TTS synthesis failed: {e}")
              import traceback
              traceback.print_exc()
              sys.exit(1)
          
          # ========== PART 3: VIDEO RENDERING =========="
          print(f"\nðŸŽ¥ PART 3: Video Rendering")
          print(f"-" * 70)
          
          try:
              from core.generators import video_renderer
              
              video_path = video_renderer.render(
                  script=script,
                  audio_map=audio_map,
                  mode=fmt
              )
              
              video_file = Path(video_path)
              if video_file.exists():
                  size_mb = video_file.stat().st_size / (1024*1024)
                  print(f"âœ… Video rendered: {video_path}")
                  print(f"   Size: {size_mb:.1f} MB")
              else:
                  raise FileNotFoundError(f"Video file not found: {video_path}")
          
          except Exception as e:
              print(f"âŒ Video rendering failed: {e}")
              import traceback
              traceback.print_exc()
              sys.exit(1)
          
          # ========== SUMMARY =========="
          print(f"\n" + "="*70)
          print(f"âœ… SUCCESS! Video generation complete")
          print(f"="*70)
          print(f"Output: {video_path}")
          print(f"Size: {size_mb:.1f} MB")
          print(f"\nReady for publishing to YouTube, TikTok, VK, Instagram")
          
          PYTHON_SCRIPT
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: horoscope-output-${{ github.run_number }}
          path: |
            output/scripts/
            output/audio/
            output/videos/
          retention-days: 7
          if-no-files-found: warn
      
      - name: Summary
        if: success()
        run: |
          echo "âœ… Video generation complete"
          echo "Format: ${{ steps.params.outputs.format }}"
          echo "Date: ${{ steps.params.outputs.date }}"
          echo ""
          echo "ðŸ“¥ Download from artifacts"
          echo "ðŸ“¤ Then publish to social media"

  notify-result:
    runs-on: ubuntu-22.04
    needs: [generate-video]
    if: always()
    
    steps:
      - name: Send Telegram notification
        run: |
          TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          
          # Only send if both tokens are set
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "âš ï¸ Telegram secrets not configured, skipping notification"
            exit 0
          fi
          
          FORMAT="${{ github.event.inputs.format || 'shorts' }}"
          STATUS="${{ needs.generate-video.result }}"
          
          if [ "$STATUS" = "success" ]; then
            EMOJI="âœ…"
            TEXT="Horoscope video generated successfully"
          else
            EMOJI="âŒ"
            TEXT="Horoscope video generation failed"
          fi
          
          MESSAGE="${EMOJI} ${TEXT}%0AFormat: ${FORMAT}%0AWorkflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          curl -s -X POST \
            -H 'Content-Type: application/x-www-form-urlencoded' \
            -d "chat_id=$TELEGRAM_CHAT_ID&text=$MESSAGE&parse_mode=HTML" \
            "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" > /dev/null || true
        continue-on-error: true
