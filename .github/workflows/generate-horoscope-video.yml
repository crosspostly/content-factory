name: Generate Horoscope Video

# –ó–∞–ø—É—Å–∫: –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ Actions –∏–ª–∏ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
on:
  workflow_dispatch:
    inputs:
      format:
        description: 'Video format (shorts | long-form | ad)'
        required: true
        default: 'shorts'
        type: choice
        options:
          - shorts
          - long-form
          - ad
      date:
        description: 'Horoscope date (YYYY-MM-DD, optional - uses today)'
        required: false
        type: string
      project:
        description: 'Project name'
        required: false
        default: 'youtube_horoscope'
        type: string
  
  # –ü–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é: –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 06:00 UTC (09:00 MSK) –¥–ª—è shorts
  schedule:
    - cron: '0 6 * * *'

jobs:
  generate-video:
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Cache system dependencies
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: ffmpeg imagemagick ghostscript fonts-dejavu-core libsm6 libxext6
          version: 1.0
      
      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y ffmpeg imagemagick ghostscript fonts-dejavu-core libsm6 libxext6
          echo "‚úÖ FFmpeg: $(ffmpeg -version | head -1)"
          echo "‚úÖ Python: $(python --version)"
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -q
      
      - name: Determine format and date
        id: params
        env:
          INPUT_FORMAT: ${{ github.event.inputs.format }}
          INPUT_DATE: ${{ github.event.inputs.date }}
          INPUT_PROJECT: ${{ github.event.inputs.project }}
        run: |
          python3 << 'EOF'
          import os
          from datetime import date
          
          # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
          fmt = os.getenv('INPUT_FORMAT') or 'shorts'
          dt = os.getenv('INPUT_DATE') or date.today().isoformat()
          proj = os.getenv('INPUT_PROJECT') or 'youtube_horoscope'
          
          print(f"Format: {fmt}")
          print(f"Date: {dt}")
          print(f"Project: {proj}")
          
          # –ó–∞–ø–∏—Å—å –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–æ–≤
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"format={fmt}\n")
              f.write(f"date={dt}\n")
              f.write(f"project={proj}\n")
          EOF
      
      - name: Generate Content (Full Pipeline with ModelRouter)
        id: generate
        env:
          GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
          PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY }}
          FORMAT: ${{ steps.params.outputs.format }}
          DATE: ${{ steps.params.outputs.date }}
          PROJECT: ${{ steps.params.outputs.project }}
        run: |
          # Run pipeline orchestrator and capture output to both console and log file
          python3 -m core.orchestrators.pipeline_orchestrator \
            --project "$PROJECT" \
            --mode "$FORMAT" \
            --date "$DATE" \
            2>&1 | tee pipeline.log
          
          # Extract output paths for next steps
          VIDEO_PATH=$(find output/videos -name "${FORMAT}.mp4" 2>/dev/null | head -1 || echo "")
          METADATA_PATH=$(find output/metadata -name "${DATE}_${FORMAT}.json" 2>/dev/null | head -1 || echo "")
          
          # Save to GitHub outputs
          if [ -n "$VIDEO_PATH" ]; then
            echo "video_path=$VIDEO_PATH" >> $GITHUB_OUTPUT
          fi
          
          if [ -n "$METADATA_PATH" ]; then
            echo "metadata_path=$METADATA_PATH" >> $GITHUB_OUTPUT
          fi
          
          # Display summary
          if [ -n "$VIDEO_PATH" ] && [ -f "$VIDEO_PATH" ]; then
            SIZE_MB=$(du -m "$VIDEO_PATH" | cut -f1)
            echo ""
            echo "=========================================="
            echo "‚úÖ Generation Complete"
            echo "=========================================="
            echo "Video: $VIDEO_PATH"
            echo "Size: ${SIZE_MB} MB"
            echo "Metadata: $METADATA_PATH"
            echo "=========================================="
            echo ""
          else
            echo "‚ùå Video file not found!"
            exit 1
          fi
      
      - name: Generate metadata
        if: success()
        env:
          PROJECT: ${{ steps.params.outputs.project }}
          FORMAT: ${{ steps.params.outputs.format }}
          DATE: ${{ steps.params.outputs.date }}
        run: |
          python3 << 'PYTHON_META'
          import json
          import os
          from datetime import datetime
          from pathlib import Path
          
          project = os.getenv('PROJECT')
          fmt = os.getenv('FORMAT')
          target_date = os.getenv('DATE')
          
          output_dir = Path(f"output/videos/{project}")
          video_files = sorted(list(output_dir.glob(f"{fmt}.mp4"))) if output_dir.exists() else []
          
          if not video_files:
              print(f"‚ÑπÔ∏è No video files to generate metadata for")
              exit(0)
          
          video_path = video_files[-1]
          
          # –°–æ–∑–¥–∞—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–ª–∞—Ç—Ñ–æ—Ä–º
          metadata = {
              "title": f"–ì–æ—Ä–æ—Å–∫–æ–ø –Ω–∞ {target_date}",
              "description": f"–í–∞—à –ª–∏—á–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø –Ω–∞ {target_date}\n\n–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫–∞–Ω–∞–ª –¥–ª—è –Ω–æ–≤—ã—Ö –≥–æ—Ä–æ—Å–∫–æ–ø–æ–≤!",
              "tags": ["–≥–æ—Ä–æ—Å–∫–æ–ø", "–∞—Å—Ç—Ä–æ–ª–æ–≥–∏—è", "–∑–æ–¥–∏–∞–∫", "–∞—Å—Ç—Ä–æ"],
              "category": "Entertainment",
              "visibility": "public",
              "format": fmt,
              "date_generated": datetime.now().isoformat(),
              "video_path": str(video_path),
          }
          
          # –§–æ—Ä–º–∞—Ç-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
          if fmt == "shorts":
              metadata["platform"] = ["YouTube Shorts", "TikTok", "Instagram Reels"]
              metadata["recommended_tags"] = ["horoscope", "astrology", "zodiac", "viral"]
          elif fmt == "long_form":
              metadata["platform"] = ["YouTube"]
              metadata["chapters"] = [
                  {"title": "–õ—é–±–æ–≤—å", "timestamp": "0:10"},
                  {"title": "–î–µ–Ω—å–≥–∏", "timestamp": "4:00"},
                  {"title": "–ó–¥–æ—Ä–æ–≤—å–µ", "timestamp": "8:00"},
              ]
          elif fmt == "ad":
              metadata["platform"] = ["YouTube", "TikTok", "Instagram"]
              metadata["ad_duration_sec"] = 15
          
          metadata_path = output_dir / f"metadata_{fmt}.json"
          with open(metadata_path, 'w') as f:
              json.dump(metadata, f, indent=2, ensure_ascii=False)
          
          print(f"‚úÖ Metadata generated: {metadata_path}")
          PYTHON_META
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: generation-logs-${{ github.run_number }}
          path: |
            pipeline.log
            output/metadata/
            output/logs/
          retention-days: 7
          if-no-files-found: warn
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: horoscope-output-${{ github.run_number }}
          path: |
            output/scripts/
            output/audio/
            output/videos/
          retention-days: 7
          if-no-files-found: warn
      
      - name: Create GitHub Summary
        if: always()
        env:
          VIDEO_PATH: ${{ steps.generate.outputs.video_path }}
          METADATA_PATH: ${{ steps.generate.outputs.metadata_path }}
          FORMAT: ${{ steps.params.outputs.format }}
          DATE: ${{ steps.params.outputs.date }}
          PROJECT: ${{ steps.params.outputs.project }}
        run: |
          echo "## üìä Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "$VIDEO_PATH" ]; then
            SIZE_MB=$(du -m "$VIDEO_PATH" | cut -f1)
            
            echo "‚úÖ **Status:** Success" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üé¨ Output" >> $GITHUB_STEP_SUMMARY
            echo "- **Video:** \`$VIDEO_PATH\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Size:** ${SIZE_MB} MB" >> $GITHUB_STEP_SUMMARY
            echo "- **Format:** $FORMAT" >> $GITHUB_STEP_SUMMARY
            echo "- **Date:** $DATE" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Parse metadata if exists
            if [ -f "$METADATA_PATH" ]; then
              echo "### üìà Generation Statistics" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
              cat "$METADATA_PATH" | python3 -c "import sys, json; data = json.load(sys.stdin); print(json.dumps(data.get('generation_stats', {}), indent=2))" >> $GITHUB_STEP_SUMMARY || echo "{}" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              echo "### üìù Script Details" >> $GITHUB_STEP_SUMMARY
              SCRIPT_LEN=$(cat "$METADATA_PATH" | python3 -c "import sys, json; print(json.load(sys.stdin).get('script_length', 'N/A'))" 2>/dev/null || echo "N/A")
              echo "- **Script length:** ${SCRIPT_LEN} characters" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "### üöÄ Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. Download artifacts from this workflow run" >> $GITHUB_STEP_SUMMARY
            echo "2. Review video quality" >> $GITHUB_STEP_SUMMARY
            echo "3. Publish to platforms: YouTube Shorts, TikTok, Instagram Reels" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Status:** Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Video file not found. Check logs for details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

  notify-result:
    runs-on: ubuntu-22.04
    needs: generate-video
    if: always() && secrets.TELEGRAM_BOT_TOKEN
    
    steps:
      - name: Send notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          FORMAT: ${{ github.event.inputs.format || 'shorts' }}
          STATUS: ${{ needs.generate-video.result }}
        run: |
          if [ "$STATUS" = "success" ]; then
            EMOJI="‚úÖ"
            TEXT="Horoscope video generated successfully"
          else
            EMOJI="‚ùå"
            TEXT="Horoscope video generation failed"
          fi
          
          MESSAGE="$EMOJI $TEXT%0AFormat: $FORMAT%0AWorkflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          curl -s -X POST \
            -H 'Content-Type: application/x-www-form-urlencoded' \
            -d "chat_id=$TELEGRAM_CHAT_ID&text=$MESSAGE&parse_mode=HTML" \
            "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" > /dev/null
