name: 1. Render Video Pipeline

on:
  push:
    branches:
      - 'project/**'
  workflow_dispatch:

jobs:
  render:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Set up FFmpeg
      uses: FedericoCarboni/setup-ffmpeg@v3

    # ===== CRITICAL: GUARANTEE FRESH INSTALL =====
    - name: "STEP 1: DELETE all pip caches"
      run: |
        echo "‚ùå Removing ALL pip caches..."
        pip cache purge || true
        rm -rf ~/.cache/pip || true
        rm -rf ~/.pip || true
        echo "‚úÖ All pip caches deleted"

    - name: "STEP 2: Upgrade pip FIRST"
      run: |
        echo "üîÑ Upgrading pip from scratch..."
        python -m pip install --upgrade --no-cache-dir pip setuptools wheel
        pip --version
        echo "‚úÖ pip upgraded"

    - name: "STEP 3: Check requirements.txt"
      run: |
        echo "üîç Checking requirements.txt..."
        if [ ! -f requirements.txt ]; then
          echo "‚ùå ERROR: requirements.txt NOT FOUND!"
          ls -la
          exit 1
        fi
        echo "‚úÖ requirements.txt found"
        echo ""
        echo "Content:"
        cat requirements.txt
        echo ""

    - name: "STEP 4: Install dependencies with AGGRESSIVE flags"
      run: |
        echo "üíæ Installing from requirements.txt..."
        echo ""
        # Use absolute maximum force
        pip install \
          --no-cache-dir \
          --force-reinstall \
          --no-deps \
          --upgrade \
          -r requirements.txt
        echo "‚úÖ Dependencies installed"

    - name: "STEP 5: Verify EACH dependency with aggressive retry"
      run: |
        echo "ü§¨ Verifying dependencies..."
        echo ""
        
        # Pillow
        python -c "from PIL import Image; print('‚úÖ Pillow OK')" || {
          echo "üîÑ Retrying Pillow..."
          pip install --no-cache-dir --force-reinstall Pillow
          python -c "from PIL import Image; print('‚úÖ Pillow OK after retry')"
        }
        
        # moviepy
        python -c "from moviepy.editor import ImageClip; print('‚úÖ moviepy OK')" || {
          echo "üîÑ Retrying moviepy..."
          pip install --no-cache-dir --force-reinstall moviepy imageio-ffmpeg
          python -c "from moviepy.editor import ImageClip; print('‚úÖ moviepy OK after retry')"
        }
        
        # pydub
        python -c "import pydub; print('‚úÖ pydub OK')" || {
          echo "üîÑ Retrying pydub..."
          pip install --no-cache-dir --force-reinstall pydub
          python -c "import pydub; print('‚úÖ pydub OK after retry')"
        }
        
        # google.generativeai
        python -c "import google.generativeai; print('‚úÖ google.generativeai OK')" || {
          echo "üîÑ Retrying google.generativeai..."
          pip install --no-cache-dir --force-reinstall google-generativeai
          python -c "import google.generativeai; print('‚úÖ google.generativeai OK after retry')"
        }
        
        echo ""
        echo "‚úÖ ALL dependencies verified"

    - name: "STEP 6: Show what's installed"
      run: |
        echo "üìä Installed packages:"
        pip list | grep -E "(Pillow|moviepy|pydub|google|requests|imageio)"

    - name: "STEP 7: Python syntax check"
      run: |
        echo "üîç Checking assemble_video.py syntax..."
        python -m py_compile assemble_video.py
        echo "‚úÖ Syntax OK"

    - name: "STEP 8: RUN THE SCRIPT"
      run: |
        echo "üöÄ ========== STARTING VIDEO ASSEMBLY =========="
        python assemble_video.py
        echo "‚úÖ ========== VIDEO ASSEMBLY COMPLETE =========="

    - name: Upload Video Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: final-video-${{ github.run_id }}
        path: "*.mp4"
        retention-days: 7

    - name: "DEBUG: Show workspace on failure"
      if: failure()
      run: |
        echo "‚ùå WORKFLOW FAILED - DEBUG INFO:"
        echo ""
        echo "=== Python Info ==="
        python --version
        which python
        echo ""
        echo "=== Pip Info ==="
        pip --version
        which pip
        echo ""
        echo "=== All installed ==="
        pip list
        echo ""
        echo "=== Workspace ==="
        ls -la
        echo ""
        echo "=== assemble_video.py first 30 lines ==="
        head -30 assemble_video.py
        echo ""
        echo "=== Try imports ==="
        python -c "from PIL import Image; print('‚úÖ PIL OK')" 2>&1 || echo "‚ùå PIL FAILED"
        python -c "from moviepy.editor import ImageClip; print('‚úÖ moviepy OK')" 2>&1 || echo "‚ùå moviepy FAILED"
        python -c "import pydub; print('‚úÖ pydub OK')" 2>&1 || echo "‚ùå pydub FAILED"
        python -c "import google.generativeai; print('‚úÖ google OK')" 2>&1 || echo "‚ùå google FAILED"
        echo ""
        exit 1
