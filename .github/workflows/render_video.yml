
name: Render Video (Branch Based)

on:
  workflow_dispatch:
    inputs:
      job_branch:
        description: 'Branch containing source_materials.zip'
        required: true
        type: string

permissions:
  contents: write
  actions: write
  issues: write

jobs:
  render:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.job_branch }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Set up FFmpeg
        uses: FedericoCarboni/setup-ffmpeg@v3
      
      - name: Install Dependencies
        run: pip install Pillow piexif requests

      - name: Verify Source Materials
        run: |
          ls -lh source_materials.zip
          unzip source_materials.zip -d .
          ls -R

      - name: Assemble Video
        run: python assemble_video.py

      - name: Check Output
        run: |
          if [ -f *.mp4 ]; then
            echo "✅ Video found"
          else
            echo "❌ No MP4 generated"
            exit 1
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: final-video-${{ github.event.inputs.job_branch }}
          path: "*.mp4"
          retention-days: 7

      - name: Cleanup Branch (Optional - Save Space)
        if: always()
        run: |
          echo "Branch cleanup skipped for debugging. Manually delete branch if needed."
          # git push origin --delete ${{ github.event.inputs.job_branch }}
