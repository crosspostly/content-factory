name: 1. Render Video Pipeline

on:
  push:
    branches:
      - 'project/**'
  workflow_dispatch:

jobs:
  render:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Set up FFmpeg
      uses: FedericoCarboni/setup-ffmpeg@v3

    # ===== DELETE CACHES =====
    - name: "[1] Delete all pip caches"
      run: |
        echo "âŒ Removing ALL pip caches..."
        pip cache purge || true
        rm -rf ~/.cache/pip || true
        rm -rf ~/.pip || true
        echo "âœ… All pip caches deleted"

    - name: "[2] Upgrade pip FIRST"
      run: |
        echo "ğŸ”„ Upgrading pip..."
        python -m pip install --upgrade --no-cache-dir pip setuptools wheel
        pip --version

    - name: "[3] Check requirements.txt"
      run: |
        if [ ! -f requirements.txt ]; then
          echo "âŒ ERROR: requirements.txt NOT FOUND!"
          exit 1
        fi
        echo "âœ… requirements.txt found"

    - name: "[4] Install dependencies with aggressive flags"
      run: |
        pip install \
          --no-cache-dir \
          --force-reinstall \
          --no-deps \
          --upgrade \
          -r requirements.txt

    - name: "[5] Verify dependencies with retry logic"
      run: |
        echo "ğŸ” Verifying dependencies..."
        
        for package in "Pillow:PIL" "moviepy:moviepy" "pydub:pydub" "google.generativeai:google.generativeai"; do
          pkg_name=$(echo $package | cut -d: -f1)
          import_name=$(echo $package | cut -d: -f2)
          
          if python -c "import $import_name" 2>/dev/null; then
            echo "âœ… $pkg_name OK"
          else
            echo "ğŸ”„ Retrying $pkg_name..."
            pip install --no-cache-dir --force-reinstall "$pkg_name" || exit 1
            python -c "import $import_name" || exit 1
            echo "âœ… $pkg_name OK after retry"
          fi
        done

    - name: "[6] CRITICAL: Check test data structure"
      run: |
        echo "ğŸ” Checking directory structure..."
        echo ""
        echo "=== Current directory ==="
        pwd
        echo ""
        echo "=== Files in repo ==="
        ls -la
        echo ""
        echo "=== Check for test data ==="
        if [ -d "test_data" ]; then
          echo "âœ… Found test_data/"
          find test_data -type f | head -20
        elif [ -d "chapters" ]; then
          echo "âœ… Found chapters/"
          find chapters -type f | head -20
        else
          echo "âŒ WARNING: No test_data or chapters directory!"
        fi
        echo ""

    - name: "[7] CRITICAL: Create minimal test structure if missing"
      run: |
        echo "ğŸ—ï¸  Creating test structure..."
        
        # Create the required directory structure
        mkdir -p chapters/chapter_01/images
        
        # Create a blank image if none exist
        if [ ! "$(ls -A chapters/chapter_01/images/)" ]; then
          echo "Creating test image..."
          python3 << 'EOF'
import os
from PIL import Image, ImageDraw

# Create 1080x1920 portrait image (or 1920x1080 for landscape)
img = Image.new('RGB', (1080, 1920), color='black')
draw = ImageDraw.Draw(img)

# Add text
text = "Test Video"
draw.text((100, 100), text, fill='white')

img.save('chapters/chapter_01/images/test_01.jpg')
print("âœ… Test image created")
EOF
        fi
        
        # Create test audio if none exists
        if [ ! -f "chapters/chapter_01/audio.mp3" ]; then
          echo "Creating test audio..."
          # 5 second silent MP3
          ffmpeg -f lavfi -i anullsrc=r=44100:cl=mono -t 5 -q:a 9 -acodec libmp3lame chapters/chapter_01/audio.mp3 2>/dev/null
          echo "âœ… Test audio created"
        fi
        
        # Create test subtitles if none exist
        if [ ! -f "chapters/chapter_01/subtitles.srt" ]; then
          echo "Creating test subtitles..."
          cat > chapters/chapter_01/subtitles.srt << 'SUBS'
1
00:00:00,000 --> 00:00:05,000
Test Subtitle
SUBS
          echo "âœ… Test subtitles created"
        fi
        
        echo ""
        echo "=== Final structure ==="
        find chapters -type f
        echo ""

    - name: "[8] Python syntax check"
      run: |
        echo "ğŸ Checking assemble_video.py syntax..."
        python -m py_compile assemble_video.py
        echo "âœ… Syntax OK"

    - name: "[9] RUN THE SCRIPT"
      run: |
        echo "ğŸš€ ========== STARTING VIDEO ASSEMBLY =========="
        python assemble_video.py
        echo "âœ… ========== VIDEO ASSEMBLY COMPLETE =========="

    - name: "[10] Verify output video"
      run: |
        echo "ğŸ” Checking output..."
        if ls *.mp4 1> /dev/null 2>&1; then
          echo "âœ… MP4 files found:"
          ls -lh *.mp4
        else
          echo "âŒ ERROR: No MP4 output file created!"
          echo ""
          echo "Checking what's in the directory:"
          ls -la
          exit 1
        fi

    - name: Upload Video Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: final-video-${{ github.run_id }}
        path: "*.mp4"
        retention-days: 7

    - name: "DEBUG: Full diagnostics on failure"
      if: failure()
      run: |
        echo "âŒ WORKFLOW FAILED - DEBUG INFO:"
        echo ""
        echo "=== Python ==="
        python --version && which python
        echo ""
        echo "=== Pip ==="
        pip --version && which pip
        pip list | grep -E "(Pillow|moviepy|pydub|google)"
        echo ""
        echo "=== FFmpeg ==="
        ffmpeg -version | head -3
        echo ""
        echo "=== Directory ==="
        ls -la
        echo ""
        echo "=== assemble_video.py first 30 lines ==="
        head -30 assemble_video.py
        echo ""
        echo "=== Try imports ==="
        python -c "from PIL import Image; print('âœ… PIL OK')" 2>&1 || echo "âŒ PIL FAILED"
        python -c "from moviepy.editor import ImageClip; print('âœ… moviepy OK')" 2>&1 || echo "âŒ moviepy FAILED"
        python -c "import pydub; print('âœ… pydub OK')" 2>&1 || echo "âŒ pydub FAILED"
        python -c "import google.generativeai; print('âœ… google OK')" 2>&1 || echo "âŒ google FAILED"
        echo ""
        exit 1
