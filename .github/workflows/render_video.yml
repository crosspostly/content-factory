name: 1. Render Video Pipeline

on:
  push:
    branches:
      - 'project/**'
  workflow_dispatch:

jobs:
  render:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Set up FFmpeg
      uses: FedericoCarboni/setup-ffmpeg@v3

    # ===== INSTALL DEPS =====
    - name: "[1] Delete pip caches"
      run: |
        pip cache purge || true
        rm -rf ~/.cache/pip || true

    - name: "[2] Upgrade pip"
      run: |
        python -m pip install --upgrade --no-cache-dir pip setuptools wheel
        pip --version

    - name: "[3] Install dependencies"
      run: |
        pip install --no-cache-dir --force-reinstall --no-deps --upgrade -r requirements.txt

    - name: "[4] Verify dependencies"
      run: |
        python -c "from PIL import Image; print('‚úÖ Pillow')"
        python -c "from moviepy.editor import ImageClip; print('‚úÖ moviepy')"
        python -c "import pydub; print('‚úÖ pydub')"

    # ===== VERIFY EXISTING DATA =====
    - name: "[5] Verify existing chapter data"
      run: |
        echo "üîç Checking for existing chapter data..."
        echo ""
        
        # Check chapter directory exists
        if [ ! -d "chapters/chapter_01" ]; then
          echo "‚ùå ERROR: chapters/chapter_01 directory not found!"
          exit 1
        fi
        echo "‚úÖ chapters/chapter_01/ exists"
        
        # Check for audio
        if [ -f "chapters/chapter_01/audio.wav" ]; then
          AUDIO_SIZE=$(du -h chapters/chapter_01/audio.wav | cut -f1)
          echo "‚úÖ audio.wav found ($AUDIO_SIZE)"
        elif [ -f "chapters/chapter_01/audio.mp3" ]; then
          AUDIO_SIZE=$(du -h chapters/chapter_01/audio.mp3 | cut -f1)
          echo "‚úÖ audio.mp3 found ($AUDIO_SIZE)"
        else
          echo "‚ùå ERROR: No audio file found!"
          exit 1
        fi
        
        # Check for images
        IMAGE_COUNT=$(find chapters/chapter_01/images -type f \( -name '*.png' -o -name '*.jpg' -o -name '*.jpeg' \) 2>/dev/null | wc -l)
        if [ "$IMAGE_COUNT" -eq 0 ]; then
          echo "‚ùå ERROR: No images in chapters/chapter_01/images/"
          exit 1
        fi
        echo "‚úÖ Found $IMAGE_COUNT images"
        
        # Check for subtitles
        if [ -f "chapters/chapter_01/subtitles.srt" ]; then
          SUB_SIZE=$(wc -l < chapters/chapter_01/subtitles.srt)
          echo "‚úÖ subtitles.srt found ($SUB_SIZE lines)"
        else
          echo "‚ö†Ô∏è  subtitles.srt not found (will be created)"
        fi
        echo ""

    - name: "[6] Show chapter structure"
      run: |
        echo "üìÇ Chapter structure:"
        ls -lh chapters/chapter_01/
        echo ""
        echo "üì∏ Images:"
        ls -lh chapters/chapter_01/images/ | head -10

    - name: "[7] Syntax check assemble_video.py"
      run: |
        python -m py_compile assemble_video.py
        echo "‚úÖ Syntax valid"

    - name: "[8] RUN VIDEO ASSEMBLY"
      run: |
        echo "üöÄ ========== STARTING VIDEO ASSEMBLY =========="
        python assemble_video.py
        echo "‚úÖ ========== ASSEMBLY COMPLETE =========="

    - name: "[9] Verify MP4 output"
      run: |
        echo "üîç Checking for MP4 output..."
        if ls *.mp4 1> /dev/null 2>&1; then
          echo "‚úÖ MP4 files created:"
          ls -lh *.mp4
          echo ""
          echo "üìä Video info:"
          ffprobe -v error -select_streams v:0 -show_entries stream=width,height,r_frame_rate -of csv=p=0 *.mp4
        else
          echo "‚ùå ERROR: No MP4 output created!"
          echo ""
          echo "Checking directory contents:"
          ls -la
          exit 1
        fi

    - name: Upload Video Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: final-video-${{ github.run_id }}
        path: "*.mp4"
        retention-days: 7

    - name: "üîß DEBUG: Failure diagnostics"
      if: failure()
      run: |
        echo "‚ùå WORKFLOW FAILED"
        echo ""
        echo "=== Python Environment ==="
        python --version
        echo ""
        echo "=== Installed Packages ==="
        pip list | grep -E "Pillow|moviepy|pydub" || echo "Packages not found"
        echo ""
        echo "=== FFmpeg ==="
        ffmpeg -version | head -3
        echo ""
        echo "=== Repository Structure ==="
        ls -la
        echo ""
        echo "=== assemble_video.py (first 40 lines) ==="
        head -40 assemble_video.py
        echo ""
        exit 1
