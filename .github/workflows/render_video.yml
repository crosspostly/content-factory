name: 1. Render Video Pipeline

on:
  push:
    branches:
      - 'project/**'
  workflow_dispatch:

jobs:
  render:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
        cache-dependency-path: 'requirements.txt'

    - name: Clear pip cache completely
      run: |
        echo "=== CLEARING PIP CACHE ==="
        pip cache purge
        rm -rf ~/.cache/pip
        echo "✅ Cache cleared"
        echo ""

    - name: Upgrade pip, setuptools, and wheel
      run: |
        echo "=== Upgrading pip and tools ==="
        python -m pip install --upgrade pip setuptools wheel --no-cache-dir
        echo "Pip version: $(pip --version)"
        echo ""

    - name: Set up FFmpeg
      uses: FedericoCarboni/setup-ffmpeg@v3

    - name: Verify requirements.txt exists
      run: |
        echo "=== Checking requirements.txt ==="
        if [ ! -f requirements.txt ]; then
          echo "❌ FATAL: requirements.txt NOT FOUND!"
          echo "Looking in repository:"
          find . -name "requirements.txt" -type f
          exit 1
        fi
        echo "✅ requirements.txt found"
        echo ""
        echo "Content:"
        cat requirements.txt
        echo ""

    - name: Install Python dependencies (NO CACHE)
      run: |
        echo "=== Installing dependencies with --no-cache-dir ==="
        pip install -r requirements.txt --no-cache-dir --verbose --force-reinstall
        echo ""
        echo "✅ Dependencies installed"
        echo ""

    - name: Verify critical imports
      run: |
        echo "=== CRITICAL: Verifying each import ==="
        echo ""
        
        # PIL/Pillow
        echo "Checking: PIL (Pillow)"
        python -c "from PIL import Image; print(f'✅ PIL (Pillow) OK')" || {
          echo "❌ FATAL: PIL import failed!"
          exit 1
        }
        
        # moviepy
        echo "Checking: moviepy"
        python -c "from moviepy.editor import ImageClip; print('✅ moviepy.editor imports OK')" || {
          echo "❌ FATAL: moviepy import failed!"
          exit 1
        }
        
        # pydub
        echo "Checking: pydub"
        python -c "import pydub; print('✅ pydub OK')" || {
          echo "❌ FATAL: pydub import failed!"
          exit 1
        }
        
        # google-generativeai
        echo "Checking: google.generativeai"
        python -c "import google.generativeai; print('✅ google.generativeai OK')" || {
          echo "❌ FATAL: google.generativeai import failed!"
          exit 1
        }
        
        echo ""
        echo "✅ ALL CRITICAL DEPENDENCIES VERIFIED!"
        echo ""

    - name: List all installed packages
      run: |
        echo "=== Installed packages ==="
        pip list
        echo ""

    - name: Verify assemble_video.py syntax
      run: |
        echo "=== Checking assemble_video.py syntax ==="
        python -m py_compile assemble_video.py
        echo "✅ Syntax OK"
        echo ""

    - name: Run Assembly Script
      run: |
        echo "=== Starting video assembly ==="
        echo ""
        python assemble_video.py
        echo ""
        echo "✅ Assembly completed"

    - name: Upload Video Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: final-video-${{ github.run_id }}
        path: "*.mp4"
        retention-days: 7

    - name: Comprehensive Debugging on failure
      if: failure()
      run: |
        echo ""
        echo "╔══════════════════════════════════════════════════════════════╗"
        echo "║              COMPREHENSIVE DEBUG REPORT                       ║"
        echo "╚══════════════════════════════════════════════════════════════╝"
        echo ""
        
        echo "=== System Information ==="
        uname -a
        echo ""
        
        echo "=== Python Information ==="
        python --version
        which python
        echo ""
        
        echo "=== Pip Information ==="
        pip --version
        which pip
        echo ""
        
        echo "=== Python Path ==="
        python -c "import sys; print('\n'.join(sys.path))"
        echo ""
        
        echo "=== All Installed Packages ==="
        pip list
        echo ""
        
        echo "=== Requirements.txt Content ==="
        if [ -f requirements.txt ]; then
          cat requirements.txt
        else
          echo "❌ requirements.txt NOT FOUND!"
        fi
        echo ""
        
        echo "=== Testing each import individually ==="
        echo ""
        
        python -c "from PIL import Image; print('✅ PIL import: OK')" 2>&1 || echo "❌ PIL import: FAILED"
        python -c "from moviepy.editor import ImageClip; print('✅ moviepy import: OK')" 2>&1 || echo "❌ moviepy import: FAILED"
        python -c "import pydub; print('✅ pydub import: OK')" 2>&1 || echo "❌ pydub import: FAILED"
        python -c "import google.generativeai; print('✅ google.generativeai import: OK')" 2>&1 || echo "❌ google.generativeai import: FAILED"
        
        echo ""
        echo "=== File Structure ==="
        ls -la
        echo ""
        
        if [ -f assemble_video.py ]; then
          echo "=== First 25 lines of assemble_video.py ==="
          head -25 assemble_video.py
        else
          echo "❌ assemble_video.py NOT FOUND!"
        fi
        echo ""
        
        echo "=== Python Compilation Test ==="
        python -m py_compile assemble_video.py 2>&1 || echo "❌ Compilation failed"
        echo ""
        
        echo "╔══════════════════════════════════════════════════════════════╗"
        echo "║                    END OF DEBUG REPORT                        ║"
        echo "╚══════════════════════════════════════════════════════════════╝"
