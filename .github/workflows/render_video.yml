name: 1. Render Video Pipeline

on:
  push:
    branches:
      - 'project/**'
  workflow_dispatch:

jobs:
  render:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Set up FFmpeg
      uses: FedericoCarboni/setup-ffmpeg@v3

    - name: Install codec support
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y libavcodec-extra
        echo "âœ… FFmpeg codec support installed"

    - name: Verify FFmpeg codecs
      run: |
        echo "=== FFmpeg Version ==="
        ffmpeg -version | head -3
        echo ""
        echo "=== Checking required codecs ==="
        if ffmpeg -codecs | grep -q 'libx264'; then
          echo "âœ… libx264 codec available"
        else
          echo "âŒ libx264 codec NOT found!"
          exit 1
        fi
        if ffmpeg -codecs | grep -q 'aac'; then
          echo "âœ… aac codec available"
        else
          echo "âŒ aac codec NOT found!"
          exit 1
        fi

    - name: Clean pip cache
      run: |
        pip cache purge
        pip install --upgrade pip setuptools wheel

    - name: Install requirements
      run: |
        python -m pip install -r requirements.txt

    - name: Test imports
      run: |
        echo "Testing critical imports..."
        python -c "import requests; print('âœ… requests')"
        python -c "import PIL; print('âœ… PIL')"
        python -c "import moviepy; print('âœ… moviepy')"
        python -c "import pydub; print('âœ… pydub')"
        python -c "import imageio; print('âœ… imageio')"
        python -c "import google; print('âœ… google-generativeai')"
        echo ""
        echo "=== All critical packages imported successfully ==="

    - name: Verify chapter data
      run: |
        echo "ðŸ” Checking chapter data..."
        [ -d "chapters/chapter_01" ] || (echo "âŒ ERROR: chapters/chapter_01 not found"; exit 1)
        echo "âœ… chapters/chapter_01 exists"
        
        [ -f "chapters/chapter_01/audio.wav" ] || [ -f "chapters/chapter_01/audio.mp3" ] || (echo "âŒ ERROR: No audio file found"; exit 1)
        echo "âœ… Audio file found"
        
        IMAGE_COUNT=$(find chapters/chapter_01/images -type f \( -name '*.png' -o -name '*.jpg' -o -name '*.jpeg' \) 2>/dev/null | wc -l)
        [ "$IMAGE_COUNT" -gt 0 ] || (echo "âŒ ERROR: No images found"; exit 1)
        echo "âœ… Found $IMAGE_COUNT images"

    - name: Show chapter structure
      run: |
        echo "ðŸ“‚ Chapter structure:"
        ls -lh chapters/chapter_01/
        echo ""
        echo "ðŸ“· Images:"
        ls -lh chapters/chapter_01/images/ | head -5

    - name: Validate Python syntax
      run: |
        python -m py_compile assemble_video.py
        echo "âœ… Syntax check passed"

    - name: Run video assembly
      run: |
        echo "ðŸš€ Starting video assembly..."
        python assemble_video.py
        echo "âœ… Video assembly complete"

    - name: Verify MP4 output
      run: |
        echo "ðŸ” Checking for MP4 files..."
        ls -lh *.mp4 2>/dev/null || (echo "âŒ ERROR: No MP4 files created"; exit 1)
        echo "âœ… MP4 files verified"

    - name: Upload artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: final-video-${{ github.run_id }}
        path: "*.mp4"
        retention-days: 7

    - name: ðŸ”§ Debug on failure
      if: failure()
      run: |
        echo "âŒ WORKFLOW FAILED - Diagnostics:"
        echo ""
        echo "=== Python ==="
        python --version
        which python
        echo ""
        echo "=== Pip ==="
        pip --version
        echo ""
        echo "=== Installed packages ==="
        pip list 2>&1 | head -30
        echo ""
        echo "=== FFmpeg ==="
        ffmpeg -version | head -5
        echo ""
        echo "=== FFmpeg Codecs ==="
        ffmpeg -codecs 2>&1 | grep -E "libx264|aac"
        echo ""
        echo "=== Directory ==="
        pwd
        ls -la
        echo ""
        exit 1
