name: 1. Render Video Pipeline

on:
  push:
    branches:
      - 'project/**'
  workflow_dispatch:

jobs:
  render:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Set up FFmpeg
      uses: FedericoCarboni/setup-ffmpeg@v3

    - name: Install codec support
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y libavcodec-extra
        echo "‚úÖ FFmpeg codec support installed"

    - name: Verify FFmpeg codecs
      run: |
        echo "=== FFmpeg Version ==="
        ffmpeg -version | head -3
        echo ""
        echo "=== Checking required codecs ==="
        if ffmpeg -codecs | grep -q 'libx264'; then
          echo "‚úÖ libx264 codec available"
        else
          echo "‚ùå libx264 codec NOT found!"
          exit 1
        fi
        if ffmpeg -codecs | grep -q 'aac'; then
          echo "‚úÖ aac codec available"
        else
          echo "‚ùå aac codec NOT found!"
          exit 1
        fi

    - name: Delete pip caches
      run: |
        pip cache purge || true
        rm -rf ~/.cache/pip || true

    - name: Upgrade pip
      run: |
        python -m pip install --upgrade pip==24.0 setuptools==68.2.2 wheel
        pip --version

    - name: Install dependencies
      run: |
        pip install --no-cache-dir -r requirements.txt

    - name: Verify dependencies
      run: |
        python -c "from PIL import Image; print('‚úÖ Pillow')"
        python -c "from moviepy.editor import ImageClip; print('‚úÖ moviepy')"
        python -c "import pydub; print('‚úÖ pydub')"
        python -c "import imageio; print('‚úÖ imageio')"

    - name: Verify existing chapter data
      run: |
        echo "üîç Checking for existing chapter data..."
        echo ""
        
        if [ ! -d "chapters/chapter_01" ]; then
          echo "‚ùå ERROR: chapters/chapter_01 directory not found!"
          exit 1
        fi
        echo "‚úÖ chapters/chapter_01/ exists"
        
        if [ ! -f "chapters/chapter_01/audio.wav" ] && [ ! -f "chapters/chapter_01/audio.mp3" ]; then
          echo "‚ùå ERROR: No audio file found!"
          exit 1
        fi
        echo "‚úÖ Audio file found"
        
        IMAGE_COUNT=$(find chapters/chapter_01/images -type f \( -name '*.png' -o -name '*.jpg' -o -name '*.jpeg' \) 2>/dev/null | wc -l)
        if [ "$IMAGE_COUNT" -eq 0 ]; then
          echo "‚ùå ERROR: No images in chapters/chapter_01/images/"
          exit 1
        fi
        echo "‚úÖ Found $IMAGE_COUNT images"
        
        if [ -f "chapters/chapter_01/subtitles.srt" ]; then
          echo "‚úÖ subtitles.srt found"
        else
          echo "‚ö†Ô∏è  subtitles.srt not found (optional)"
        fi
        echo ""

    - name: Show chapter structure
      run: |
        echo "üìÇ Chapter structure:"
        ls -lh chapters/chapter_01/
        echo ""
        echo "üì∑ Images:"
        ls -lh chapters/chapter_01/images/ | head -10

    - name: Syntax check assemble_video.py
      run: |
        python -m py_compile assemble_video.py
        echo "‚úÖ Syntax valid"

    - name: RUN VIDEO ASSEMBLY
      run: |
        echo "üöÄ ========== STARTING VIDEO ASSEMBLY =========="
        python assemble_video.py
        echo "‚úÖ ========== ASSEMBLY COMPLETE =========="

    - name: Verify MP4 output
      run: |
        echo "üîç Checking for MP4 output..."
        if ls *.mp4 1> /dev/null 2>&1; then
          echo "‚úÖ MP4 files created:"
          ls -lh *.mp4
          echo ""
          echo "üìä Video info:"
          ffprobe -v error -select_streams v:0 -show_entries stream=width,height,r_frame_rate -of csv=p=0 *.mp4 || true
        else
          echo "‚ùå ERROR: No MP4 output created!"
          echo ""
          echo "Directory contents:"
          ls -la
          exit 1
        fi

    - name: Upload Video Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: final-video-${{ github.run_id }}
        path: "*.mp4"
        retention-days: 7

    - name: üîß Debug on failure
      if: failure()
      run: |
        echo "‚ùå WORKFLOW FAILED"
        echo ""
        echo "=== Python ==="
        python --version
        echo ""
        echo "=== Packages ==="
        pip list | grep -E "Pillow|moviepy|imageio|pydub" || echo "Packages not found"
        echo ""
        echo "=== FFmpeg ==="
        ffmpeg -version | head -3
        echo ""
        echo "=== FFmpeg Codecs ==="
        ffmpeg -codecs | grep -E "libx264|aac" || echo "Codecs not found"
        echo ""
        echo "=== Directory ==="
        ls -la
        echo ""
        exit 1
