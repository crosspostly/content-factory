name: 1. Render Video Pipeline

on:
  push:
    branches:
      - 'project/**'
  workflow_dispatch:

jobs:
  setup-and-render:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install system dependencies
      run: |
        echo "ğŸš€ Installing system dependencies..."
        sudo apt-get update -qq
        sudo apt-get install -y ffmpeg libavcodec-extra
        echo "âœ… System dependencies installed"

    - name: Install Python dependencies
      run: |
        echo "ğŸš€ Installing Python dependencies..."
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt --no-cache-dir
        echo "âœ… Python dependencies installed"

    - name: Verify critical imports
      run: |
        echo "ğŸ” Verifying imports..."
        python -c "import requests; import PIL; import moviepy; import google.generativeai; print('âœ… All imports successful')"

    - name: Setup dummy data if missing
      run: |
        echo "ğŸš€ Setting up chapter data..."
        
        # Create chapter directory
        mkdir -p chapters/chapter_01/images
        
        # Create dummy image if missing
        if [ ! -f "chapters/chapter_01/images/001.png" ]; then
          echo "Creating dummy image..."
          python3 << 'PYTHON_SCRIPT'
import os
from PIL import Image, ImageDraw, ImageFont

# Create a simple test image
img = Image.new('RGB', (1920, 1080), color=(73, 109, 137))
draw = ImageDraw.Draw(img)

# Add text
try:
    # Try to use default font
    draw.text((960, 540), "TEST IMAGE", fill=(255, 255, 255), anchor="mm")
except:
    # Fallback to default
    draw.text((960, 540), "TEST IMAGE", fill=(255, 255, 255))

img.save('chapters/chapter_01/images/001.png')
print("âœ… Created dummy image")
PYTHON_SCRIPT
        fi
        
        # Create dummy audio if missing
        if [ ! -f "chapters/chapter_01/audio.wav" ] && [ ! -f "chapters/chapter_01/audio.mp3" ]; then
          echo "Creating dummy audio..."
          python3 << 'PYTHON_SCRIPT'
from pydub import AudioSegment
from pydub.generators import Sine

# Generate a simple 3-second sine wave at 440 Hz
print("ğŸ†˜ Generating test audio...")
test_tone = Sine(440).to_audio_segment(duration=3000)  # 3 seconds
test_tone.export('chapters/chapter_01/audio.wav', format='wav')
print("âœ… Created dummy audio (3 seconds)")
PYTHON_SCRIPT
        fi
        
        echo "âœ… Chapter data ready"

    - name: Verify chapter structure
      run: |
        echo "ğŸ“‚ Chapter structure:"
        ls -lh chapters/chapter_01/
        echo ""
        echo "ğŸ“· Images:"
        ls -lh chapters/chapter_01/images/
        echo ""
        echo "ğŸ”Š Audio:"
        ls -lh chapters/chapter_01/audio.*

    - name: Run video assembly
      run: |
        echo "ğŸš€ Starting video assembly..."
        python assemble_video.py
        echo "âœ… Video assembly complete"

    - name: Verify MP4 output
      run: |
        echo "ğŸ” Checking for MP4 files..."
        ls -lh *.mp4 || (echo "âŒ ERROR: No MP4 files created"; exit 1)
        echo "âœ… MP4 files verified"

    - name: Upload artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: final-video-${{ github.run_id }}
        path: "*.mp4"
        retention-days: 7

    - name: ğŸ”§ Debug on failure
      if: failure()
      run: |
        echo "âŒ WORKFLOW FAILED - Diagnostics:"
        echo ""
        echo "=== Python ==="
        python --version
        echo ""
        echo "=== Installed packages ==="
        pip list 2>&1 | head -40
        echo ""
        echo "=== FFmpeg ==="
        ffmpeg -version | head -3
        echo ""
        echo "=== Directory ==="
        pwd
        ls -la
        echo ""
        exit 1
