name: 1. Render Video Pipeline

on:
  push:
    branches:
      - 'project/**'
  workflow_dispatch:

jobs:
  render-video:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    outputs:
      video-files: ${{ steps.build.outputs.video-files }}
      build-status: ${{ job.status }}
    
    steps:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 1. SETUP ENVIRONMENT
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: ğŸ Setup Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 2. INSTALL SYSTEM & PYTHON DEPENDENCIES
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    - name: ğŸ“¦ Install system dependencies
      run: |
        set -e
        echo "Installing FFmpeg and required libraries..."
        sudo apt-get update -qq
        sudo apt-get install -y --no-install-recommends \
          ffmpeg \
          libavcodec-extra \
          libfreetype6-dev \
          libjpeg-dev \
          libopenjp2-7-dev \
          libtiff-dev \
          libwebp-dev \
          zlib1g-dev
        echo "âœ… System dependencies installed"
        ffmpeg -version | head -3

    - name: ğŸ”§ Install Python dependencies
      run: |
        set -e
        echo "Upgrading pip..."
        python -m pip install --upgrade pip setuptools wheel
        echo "Installing requirements..."
        pip install -r requirements.txt
        echo "âœ… Python dependencies installed"

    - name: âœ… Verify critical imports
      run: |
        echo "Verifying imports..."
        python3 << 'EOF'
import sys
try:
    import requests
    print("âœ… requests")
except ImportError as e:
    print(f"âŒ requests: {e}")
    sys.exit(1)

try:
    from PIL import Image
    print("âœ… PIL")
except ImportError as e:
    print(f"âŒ PIL: {e}")
    sys.exit(1)

try:
    from moviepy.editor import ImageClip, AudioFileClip, concatenate_videoclips
    print("âœ… moviepy")
except ImportError as e:
    print(f"âŒ moviepy: {e}")
    sys.exit(1)

try:
    import google.generativeai
    print("âœ… google.generativeai")
except ImportError as e:
    print(f"âš ï¸  google.generativeai (optional): {e}")

print("\nâœ… All critical imports verified!")
EOF

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 3. PREPARE TEST DATA
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    - name: ğŸ“‚ Create chapter structure
      run: |
        echo "Creating chapter directories..."
        mkdir -p chapters/chapter_01/images
        echo "âœ… Directories created"

    - name: ğŸ–¼ï¸ Generate test image
      run: |
        python3 << 'EOF'
import os
from pathlib import Path
from PIL import Image, ImageDraw, ImageFont

images_dir = Path('chapters/chapter_01/images')

# Create 3 test images
for i in range(1, 4):
    # Create gradient background
    img = Image.new('RGB', (1920, 1080), color=(73, 109, 137))
    draw = ImageDraw.Draw(img)
    
    # Add text
    text = f"Test Slide {i}"
    try:
        font = ImageFont.load_default()
    except:
        font = ImageFont.load_default()
    
    # Draw text in center
    bbox = draw.textbbox((0, 0), text, font=font)
    text_width = bbox[2] - bbox[0]
    text_height = bbox[3] - bbox[1]
    x = (1920 - text_width) // 2
    y = (1080 - text_height) // 2
    
    draw.text((x, y), text, fill=(255, 255, 255), font=font)
    
    # Save
    filename = images_dir / f"{i:03d}.png"
    img.save(filename)
    print(f"âœ… Created {filename.name}")

EOF

    - name: ğŸ”Š Generate test audio
      run: |
        python3 << 'EOF'
from pydub import AudioSegment
from pydub.generators import Sine
import os

audio_file = 'chapters/chapter_01/audio.wav'

# Generate 9 seconds of sine wave (3 images Ã— 3 seconds each)
print("Generating test audio (9 seconds)...")
test_tone = Sine(440).to_audio_segment(duration=9000)  # 9 seconds
test_tone.export(audio_file, format='wav')

size_kb = os.path.getsize(audio_file) / 1024
print(f"âœ… Created {audio_file} ({size_kb:.1f} KB)")

EOF

    - name: ğŸ“‹ Verify chapter data
      run: |
        echo "=== Chapter Structure ==="
        find chapters/chapter_01 -type f | sort
        echo ""
        echo "=== File Sizes ==="
        du -sh chapters/chapter_01/*
        echo ""
        echo "âœ… Chapter data ready for assembly"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 4. BUILD VIDEO
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    - name: ğŸ¬ Assemble video
      id: build
      run: |
        set -e
        echo "Starting video assembly..."
        python3 assemble_video.py
        
        # Find generated MP4 files
        video_files=$(find . -maxdepth 1 -name '*.mp4' -type f | tr '\n' ',' | sed 's/,$//')
        echo "video-files=$video_files" >> $GITHUB_OUTPUT
        
        echo "âœ… Video assembly complete"

    - name: âœ… Verify output
      run: |
        echo "=== Generated Files ==="
        ls -lh *.mp4 2>/dev/null || echo "No MP4 files found"
        echo ""
        
        # Count MP4 files
        count=$(find . -maxdepth 1 -name '*.mp4' -type f | wc -l)
        if [ "$count" -eq 0 ]; then
          echo "âŒ ERROR: No MP4 files were created!"
          exit 1
        fi
        
        echo "âœ… Found $count video file(s)"
        
        # Check video properties with ffprobe
        for mp4 in *.mp4; do
          if command -v ffprobe &> /dev/null; then
            echo ""
            echo "Video: $mp4"
            ffprobe -v error -show_entries format=duration,size -of default=noprint_wrappers=1 "$mp4" || true
          fi
        done

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 5. UPLOAD ARTIFACTS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    - name: ğŸ“¤ Upload video artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: rendered-videos-${{ github.run_id }}
        path: |
          *.mp4
        retention-days: 7
        compression-level: 0

    - name: ğŸ“¤ Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.run_id }}
        path: |
          video_assembly.log
        retention-days: 3

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 6. FINAL REPORT
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    - name: ğŸ“Š Build report
      if: always()
      run: |
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ‰ RENDER VIDEO WORKFLOW - SUMMARY"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "Status: ${{ job.status }}"
        echo "Run ID: ${{ github.run_id }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo ""
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… Videos generated successfully!"
          echo ""
          echo "Output files:"
          ls -lh *.mp4 2>/dev/null || echo "(no MP4 files)"
        else
          echo "âŒ Workflow failed"
          echo "Check logs above for details"
        fi
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 7. DEBUGGING (if failed)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    - name: ğŸ” Debug information
      if: failure()
      run: |
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ”§ DEBUG INFO"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "=== Python ==="
        python --version
        echo ""
        echo "=== Installed packages ==="
        pip list 2>&1 | grep -E '(moviepy|PIL|ffmpeg|pydub)' || true
        echo ""
        echo "=== FFmpeg ==="
        ffmpeg -version | head -2
        echo ""
        echo "=== Directory Structure ==="
        find . -type f -name '*.mp4' -o -name '*.log' | head -20
        echo ""
        echo "=== Last 50 lines of video_assembly.log ==="
        tail -50 video_assembly.log 2>/dev/null || echo "(no log file)"
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
