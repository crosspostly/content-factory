name: 1. Render Video Pipeline

on:
  push:
    branches:
      - 'project/**'
  workflow_dispatch:

jobs:
  render:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Clear pip cache
      run: |
        echo "ðŸš€ Clearing pip cache..."
        rm -rf ~/.cache/pip
        pip cache purge || true
        echo "âœ… Pip cache cleared"

    - name: Upgrade pip and install build tools
      run: |
        echo "ðŸš€ Upgrading pip..."
        python3 -m pip install --upgrade pip setuptools wheel
        echo "âœ… Pip upgraded"

    - name: Verify pip works
      run: |
        pip --version
        python3 -m pip --version

    - name: Set up FFmpeg
      uses: FedericoCarboni/setup-ffmpeg@v3

    - name: Install codec support
      run: |
        echo "ðŸš€ Installing codec support..."
        sudo apt-get update -qq
        sudo apt-get install -y libavcodec-extra
        echo "âœ… FFmpeg codec support installed"

    - name: Verify FFmpeg codecs
      run: |
        echo "=== FFmpeg Version ==="
        ffmpeg -version | head -3
        echo ""
        echo "=== Checking required codecs ==="
        if ffmpeg -codecs 2>&1 | grep -q 'libx264'; then
          echo "âœ… libx264 codec available"
        else
          echo "âŒ libx264 codec NOT found!"
          exit 1
        fi
        if ffmpeg -codecs 2>&1 | grep -q 'aac'; then
          echo "âœ… aac codec available"
        else
          echo "âŒ aac codec NOT found!"
          exit 1
        fi

    - name: Show Python environment
      run: |
        echo "=== Python Info ==="
        python3 --version
        python3 -c "import sys; print(f'Python path: {sys.executable}')"
        which python3
        echo ""
        echo "=== Pip Info ==="
        pip --version
        python3 -m pip --version

    - name: Install requirements with verbose output
      run: |
        echo "ðŸš€ Installing requirements..."
        python3 -m pip install --verbose -r requirements.txt 2>&1 | tail -50
        echo ""
        echo "âœ… Installation complete"

    - name: Verify all imports work
      run: |
        echo "ðŸ” Testing critical imports..."
        python3 -c "import requests; print('  âœ… requests')"
        python3 -c "import PIL; print('  âœ… PIL/Pillow')"
        python3 -c "import moviepy; print('  âœ… moviepy')"
        python3 -c "import pydub; print('  âœ… pydub')"
        python3 -c "import imageio; print('  âœ… imageio')"
        python3 -c "import google.generativeai; print('  âœ… google-generativeai')"
        echo ""
        echo "=== All critical packages imported successfully ==="

    - name: List installed packages
      run: |
        echo "=== Installed packages ==="
        pip list | head -30

    - name: Verify chapter data
      run: |
        echo "ðŸ” Checking chapter data..."
        if [ ! -d "chapters/chapter_01" ]; then
          echo "âŒ ERROR: chapters/chapter_01 not found"
          exit 1
        fi
        echo "âœ… chapters/chapter_01 exists"
        
        if [ ! -f "chapters/chapter_01/audio.wav" ] && [ ! -f "chapters/chapter_01/audio.mp3" ]; then
          echo "âŒ ERROR: No audio file found"
          exit 1
        fi
        echo "âœ… Audio file found"
        
        IMAGE_COUNT=$(find chapters/chapter_01/images -type f \( -name '*.png' -o -name '*.jpg' -o -name '*.jpeg' \) 2>/dev/null | wc -l)
        if [ "$IMAGE_COUNT" -lt 1 ]; then
          echo "âŒ ERROR: No images found"
          exit 1
        fi
        echo "âœ… Found $IMAGE_COUNT images"

    - name: Show chapter structure
      run: |
        echo "ðŸ“‚ Chapter structure:"
        ls -lh chapters/chapter_01/
        echo ""
        echo "ðŸ“· Images:"
        ls -lh chapters/chapter_01/images/ | head -5

    - name: Validate Python syntax
      run: |
        python3 -m py_compile assemble_video.py
        echo "âœ… Syntax check passed"

    - name: Run video assembly
      run: |
        echo "ðŸš€ Starting video assembly..."
        python3 assemble_video.py
        if [ $? -ne 0 ]; then
          echo "âŒ Video assembly failed with exit code $?"
          exit 1
        fi
        echo "âœ… Video assembly complete"

    - name: Verify MP4 output
      run: |
        echo "ðŸ” Checking for MP4 files..."
        MP4_COUNT=$(ls -1 *.mp4 2>/dev/null | wc -l)
        if [ "$MP4_COUNT" -lt 1 ]; then
          echo "âŒ ERROR: No MP4 files created"
          exit 1
        fi
        echo "âœ… Found $MP4_COUNT MP4 file(s)"
        ls -lh *.mp4

    - name: Upload artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: final-video-${{ github.run_id }}
        path: "*.mp4"
        retention-days: 7

    - name: ðŸ”§ Debug on failure
      if: failure()
      run: |
        echo "âŒ WORKFLOW FAILED - Diagnostics:"
        echo ""
        echo "=== Python ==="
        python3 --version
        which python3
        echo ""
        echo "=== Pip ==="
        pip --version
        echo ""
        echo "=== Installed packages ==="
        pip list 2>&1 | head -40
        echo ""
        echo "=== Try importing requests directly ==="
        python3 -c "import sys; print('Python path:', sys.path); import requests; print('âœ… requests imported')" || echo "âŒ Failed to import requests"
        echo ""
        echo "=== FFmpeg ==="
        ffmpeg -version | head -5
        echo ""
        echo "=== FFmpeg Codecs ==="
        ffmpeg -codecs 2>&1 | grep -E "libx264|aac"
        echo ""
        echo "=== Directory ==="
        pwd
        ls -la
        echo ""
        exit 1
