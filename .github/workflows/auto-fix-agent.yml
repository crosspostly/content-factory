name: Auto-Fix Agent

on:
  workflow_run:
    workflows: ["tests.yml", "Docker Build"]
    types: [completed]
  
permissions:
  contents: write
  issues: write
  pull-requests: write
  checks: read

jobs:
  auto-fix-analysis:
    name: Auto-Fix Analysis
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get workflow failure info
        id: failure-info
        run: |
          echo "workflow_run_id=${{ github.event.workflow_run.id }}" >> $GITHUB_OUTPUT
          echo "workflow_name=${{ github.event.workflow_run.name }}" >> $GITHUB_OUTPUT
          echo "run_number=${{ github.event.workflow_run.run_number }}" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-generativeai pyyaml requests
      
      - name: Run Auto-Fix Agent
        id: auto-fix
        env:
          GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
          GH_TOKEN: ${{ github.token }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import sys
          import os
          sys.path.insert(0, '.')
          
          try:
              from core.auto_fix_agent import analyze_workflow_error, create_github_issue
          except ImportError as e:
              print(f"âš ï¸  Could not import auto_fix_agent: {e}")
              sys.exit(0)
          
          project_name = "content-factory"
          workflow_name = "${{ steps.failure-info.outputs.workflow_name }}"
          workflow_id = "${{ steps.failure-info.outputs.workflow_run_id }}"
          run_number = "${{ steps.failure-info.outputs.run_number }}"
          
          # Create a simple error message from context
          error_logs = f"""
          Workflow: {workflow_name}
          Run ID: {workflow_id}
          Status: Failed
          
          Check GitHub Actions logs for details:
          https://github.com/${{ github.repository }}/actions/runs/{workflow_id}
          """
          
          print(f"ðŸ” Analyzing workflow failure: {workflow_name}")
          
          try:
              # Analyze the error
              analysis = analyze_workflow_error(
                  project_name,
                  workflow_name,
                  error_logs,
                  config=None
              )
              
              print(f"âœ… Analysis complete")
              print(f"   Problem: {analysis.get('problem', 'Unknown')}")
              print(f"   Severity: {analysis.get('severity', 'unknown')}")
              print(f"   Auto-fix possible: {analysis.get('auto_fix_possible', False)}")
              
              # Create GitHub Issue with analysis
              issue_url = create_github_issue(
                  project_name,
                  workflow_id,
                  run_number,
                  analysis
              )
              
              if issue_url:
                  print(f"âœ… Issue created: {issue_url}")
              else:
                  print(f"âš ï¸  Could not create issue")
                  
          except Exception as e:
              print(f"âŒ Auto-Fix Agent failed: {str(e)}")
              import traceback
              traceback.print_exc()
          
          PYTHON_SCRIPT
        continue-on-error: true
