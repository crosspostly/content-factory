name: Auto-Fix Agent

# Ð¡Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð¢ÐžÐ›Ð¬ÐšÐž ÐºÐ¾Ð³Ð´Ð° Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ð°Ð´Ð°ÑŽÑ‚ Ð½Ð° feature branch
on:
  workflow_run:
    workflows: ["Run Tests", "Run Tests in Docker"]
    types: [completed]

permissions:
  contents: write
  issues: write
  pull-requests: write
  checks: read

jobs:
  auto-fix-analysis:
    name: Auto-Fix Analysis
    runs-on: ubuntu-latest
    # Ð¢ÐžÐ›Ð¬ÐšÐž ÐµÑÐ»Ð¸: 1) workflow ÑƒÐ¿Ð°Ð», 2) ÑÑ‚Ð¾ ÐÐ• main, 3) ÑÑ‚Ð¾ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¹ run (Ð½Ðµ workflow_dispatch)
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.head_branch != 'main' &&
      github.event.workflow_run.head_branch != null
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_branch }}
      
      - name: Check for duplicate auto-fix
        id: check-duplicate
        run: |
          EXISTING=$(gh issue list --state open --label "auto-fix-pending" --search "workflow_run:${{ github.event.workflow_run.id }}" --json number | jq length)
          if [ "$EXISTING" -gt 0 ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "âœ… Auto-fix ÑƒÐ¶Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð° Ð´Ð»Ñ ÑÑ‚Ð¾Ð³Ð¾ run"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}
        continue-on-error: true
      
      - name: Create auto-fix issue
        if: steps.check-duplicate.outputs.skip != 'true'
        run: |
          BODY="## Auto-Fix: Workflow Failure\n\n"
          BODY="${BODY}**Workflow**: ${{ github.event.workflow_run.name }}\n"
          BODY="${BODY}**Branch**: ${{ github.event.workflow_run.head_branch }}\n"
          BODY="${BODY}**Run ID**: ${{ github.event.workflow_run.id }}\n"
          BODY="${BODY}**Status**: Failed\n\n"
          BODY="${BODY}[View workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})\n"
          BODY="${BODY}\n**Agent Status**: Analyzing error...\n\n"
          BODY="${BODY}workflow_run:${{ github.event.workflow_run.id }}"
          
          gh issue create \
            --title "ðŸ¤– Auto-Fix: ${{ github.event.workflow_run.name }} failed" \
            --body "$BODY" \
            --label "auto-fix-pending,auto-generated" \
            --assignee "@me" || true
        env:
          GH_TOKEN: ${{ github.token }}

  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'failure'
    steps:
      - name: Send Telegram notification
        if: secrets.TELEGRAM_BOT_TOKEN
        run: |
          MESSAGE="ðŸ”´ Workflow Failed\n"
          MESSAGE="${MESSAGE}Workflow: ${{ github.event.workflow_run.name }}\n"
          MESSAGE="${MESSAGE}Branch: ${{ github.event.workflow_run.head_branch }}\n"
          MESSAGE="${MESSAGE}Run: ${{ github.event.workflow_run.id }}\n\n"
          MESSAGE="${MESSAGE}[View Details](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})"
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=$MESSAGE" \
            -d "parse_mode=Markdown" > /dev/null || true
        continue-on-error: true
