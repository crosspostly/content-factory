name: Auto-Fix Agent

# Ð¢ÐžÐ›Ð¬ÐšÐž Ð½Ð° feature branches - ÐÐ• Ð½Ð° main!
on:
  workflow_run:
    workflows: ["Run Tests", "Run Tests in Docker"]
    types: [completed]
  
permissions:
  contents: write
  issues: write
  pull-requests: write
  checks: read

jobs:
  auto-fix-analysis:
    name: Auto-Fix Analysis
    runs-on: ubuntu-latest
    # Ð’ÐÐ–ÐÐž: ÑÑ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ workflow ÑƒÐ¿Ð°Ð» Ð˜ ÑÑ‚Ð¾ Ð½Ðµ main branch
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.head_branch != 'main' &&
      github.event.workflow_run.head_branch != null &&
      github.event.workflow_run.event != 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_branch }}
      
      - name: Get workflow failure info
        id: failure-info
        run: |
          echo "workflow_run_id=${{ github.event.workflow_run.id }}" >> $GITHUB_OUTPUT
          echo "workflow_name=${{ github.event.workflow_run.name }}" >> $GITHUB_OUTPUT
          echo "run_number=${{ github.event.workflow_run.run_number }}" >> $GITHUB_OUTPUT
          echo "branch_name=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Check for duplicate issue
        id: check-duplicate
        run: |
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐµÑÑ‚ÑŒ Ð»Ð¸ ÑƒÐ¶Ðµ issue Ð´Ð»Ñ ÑÑ‚Ð¾Ð³Ð¾ workflow run
          ISSUES=$(gh issue list --state open --label auto-generated --json title,body -q '.[] | select(.body | contains("${{ github.event.workflow_run.id }}")) | .title')
          if [ -n "$ISSUES" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "âœ… Issue ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð´Ð»Ñ ÑÑ‚Ð¾Ð³Ð¾ run"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}
        continue-on-error: true
      
      - name: Set up Python
        if: steps.check-duplicate.outputs.skip != 'true'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        if: steps.check-duplicate.outputs.skip != 'true'
        run: |
          python -m pip install --upgrade pip
          pip install google-generativeai pyyaml requests
      
      - name: Run Auto-Fix Agent
        if: steps.check-duplicate.outputs.skip != 'true'
        id: auto-fix
        env:
          GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
          GH_TOKEN: ${{ github.token }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import sys
          import os
          sys.path.insert(0, '.')
          
          try:
              from core.auto_fix_agent import analyze_workflow_error, create_github_issue
          except ImportError as e:
              print(f"âš ï¸  Could not import auto_fix_agent: {e}")
              sys.exit(0)
          
          project_name = "content-factory"
          workflow_name = "${{ steps.failure-info.outputs.workflow_name }}"
          workflow_id = "${{ steps.failure-info.outputs.workflow_run_id }}"
          run_number = "${{ steps.failure-info.outputs.run_number }}"
          branch_name = "${{ steps.failure-info.outputs.branch_name }}"
          
          # Create a simple error message from context
          error_logs = f"""
          Workflow: {workflow_name}
          Run ID: {workflow_id}
          Branch: {branch_name}
          Status: Failed
          
          Check GitHub Actions logs for details:
          https://github.com/${{ github.repository }}/actions/runs/{workflow_id}
          """
          
          print(f"ðŸ” Analyzing workflow failure on branch: {branch_name}")
          print(f"ðŸŒ– Sending to Qwen/Gemini for analysis...")
          
          try:
              # Analyze the error
              analysis = analyze_workflow_error(
                  project_name,
                  workflow_name,
                  error_logs,
                  config=None
              )
              
              print(f"âœ… Analysis complete")
              print(f"   Problem: {analysis.get('problem', 'Unknown')}")
              print(f"   Severity: {analysis.get('severity', 'unknown')}")
              print(f"   Auto-fix possible: {analysis.get('auto_fix_possible', False)}")
              
              # Create GitHub Issue with analysis
              issue_url = create_github_issue(
                  project_name,
                  workflow_id,
                  run_number,
                  analysis
              )
              
              if issue_url:
                  print(f"ðŸ“‹ Issue created: {issue_url}")
                  with open('/tmp/issue_url.txt', 'w') as f:
                      f.write(issue_url)
              else:
                  print(f"âš ï¸  Could not create issue")
                  
          except Exception as e:
              print(f"âŒ Auto-Fix Agent failed: {str(e)}")
              import traceback
              traceback.print_exc()
          
          PYTHON_SCRIPT
        continue-on-error: true
      
      - name: Comment on PR
        if: always() && steps.check-duplicate.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = "ðŸ” **Auto-Fix Agent** analyzed the failure:\n\n";
            
            if (fs.existsSync('/tmp/issue_url.txt')) {
              const issueUrl = fs.readFileSync('/tmp/issue_url.txt', 'utf8').trim();
              comment += `ðŸ“‹ [View detailed analysis](${issueUrl})`;
            } else {
              comment += "âš ï¸ Analysis did not produce an issue";
            }
            
            // Find and comment on PR
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${{ github.event.workflow_run.head_branch }}`
            });
            
            if (pullRequests.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pullRequests[0].number,
                body: comment
              });
            }
        continue-on-error: true
