name: Auto-Fix Agent

on:
  workflow_run:
    workflows: ["tests.yml", "part1-test.yml", "tests-docker.yml"]
    types: [completed]

jobs:
  analyze-and-fix:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    permissions:
      contents: write
      actions: read
      issues: write
      pull-requests: write
      repository-projects: read
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get workflow details
        id: workflow
        run: |
          echo "workflow_name=${{ github.event.workflow_run.name }}" >> $GITHUB_OUTPUT
          echo "workflow_id=${{ github.event.workflow_run.id }}" >> $GITHUB_OUTPUT
          echo "run_number=${{ github.event.workflow_run.run_number }}" >> $GITHUB_OUTPUT
          echo "head_branch=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
          echo "head_sha=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
      
      - name: Download workflow artifacts
        run: |
          mkdir -p /tmp/artifacts
          gh run download ${{ github.event.workflow_run.id }} -D /tmp/artifacts || echo "No artifacts found"
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Fetch workflow logs
        id: logs
        run: |
          gh run view ${{ github.event.workflow_run.id }} --log > /tmp/workflow.log 2>&1 || true
          
          # Extract last 100 lines with errors
          tail -100 /tmp/workflow.log > /tmp/error_context.log || cat /tmp/workflow.log > /tmp/error_context.log
          
          # Count errors
          ERROR_COUNT=$(grep -i "error\|failed\|exception" /tmp/workflow.log | wc -l)
          echo "error_count=$ERROR_COUNT" >> $GITHUB_OUTPUT
          echo "log_size=$(wc -c < /tmp/workflow.log)" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Create issue with error analysis
        id: issue
        run: |
          python3 << 'PYTHON_SCRIPT'
          import subprocess
          import os
          import json
          from datetime import datetime
          
          # Read error logs
          try:
              with open('/tmp/error_context.log', 'r') as f:
                  error_logs = f.read()
          except:
              error_logs = "No logs available"
          
          workflow_name = "${{ steps.workflow.outputs.workflow_name }}"
          run_id = "${{ steps.workflow.outputs.workflow_id }}"
          run_number = "${{ steps.workflow.outputs.run_number }}"
          
          # Parse main error
          error_lines = [line for line in error_logs.split('\n') if 'error' in line.lower() or 'failed' in line.lower()]
          main_error = error_lines[-1] if error_lines else "Unknown error"
          
          issue_title = f"ðŸ”´ [{workflow_name} #{run_number}] Workflow failed"
          
          issue_body = f"""## Automated Failure Report
          
**Workflow:** [{workflow_name}](https://github.com/${{ github.repository }}/actions/runs/{run_id})
**Run:** #{run_number}
**Branch:** `${{ steps.workflow.outputs.head_branch }}`
**Commit:** `${{ steps.workflow.outputs.head_sha }}`
**Time:** {datetime.now().isoformat()}

### Error Summary
```
{main_error[:500]}
```

### Error Context (Last 50 lines)
```
{chr(10).join(error_logs.split(chr(10))[-50:])}
```

### Next Steps
1. âœ… **Copilot is analyzing** this failure
2. An auto-fix PR will be created if possible
3. Manual review recommended before merge

---
*Generated by Auto-Fix Agent ðŸ¤–*
"""
          
          result = subprocess.run(
              [
                  "gh", "issue", "create",
                  "--title", issue_title,
                  "--body", issue_body,
                  "--label", "bug,auto-generated,ai-analyzed"
              ],
              capture_output=True,
              text=True,
              env={**os.environ, "GH_TOKEN": "${{ github.token }}"}
          )
          
          if result.returncode == 0:
              issue_url = result.stdout.strip()
              print(f"âœ… Created issue: {issue_url}")
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write(f"issue_url={issue_url}\n")
          else:
              print(f"âš ï¸ Failed to create issue")
          
          PYTHON_SCRIPT
      
      - name: Assign Copilot to analyze
        if: ${{ steps.issue.outputs.issue_url != '' }}
        run: |
          # Extract issue number from URL
          ISSUE_URL="${{ steps.issue.outputs.issue_url }}"
          ISSUE_NUMBER=$(echo $ISSUE_URL | grep -oP '(?<=/issues/)\d+')
          
          echo "ðŸ“‹ Assigned issue #$ISSUE_NUMBER for Copilot analysis"
          echo "ðŸ¤– Copilot will:"
          echo "  - Analyze the workflow logs"
          echo "  - Identify root cause"
          echo "  - Create fix PR if applicable"
          echo "  - Add detailed comments"
          echo ""
          echo "ðŸ“ Issue: ${{ steps.issue.outputs.issue_url }}"
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Trigger Copilot coding task
        continue-on-error: true
        run: |
          python3 << 'PYTHON_SCRIPT'
          import subprocess
          import os
          
          issue_url = "${{ steps.issue.outputs.issue_url }}"
          if not issue_url:
              print("No issue created, skipping Copilot assignment")
              exit(0)
          
          # Extract owner, repo, issue_number
          parts = issue_url.strip('/').split('/')
          owner = parts[-4]
          repo = parts[-3]
          issue_number = parts[-1]
          
          print(f"ðŸš€ Assigning Copilot to issue #{issue_number}...")
          print(f"   Owner: {owner}")
          print(f"   Repo: {repo}")
          
          # Use GitHub CLI to assign (Copilot assignment requires GitHub Enterprise)
          # For now, just add comment indicating Copilot should review
          comment_body = """ðŸ¤– **Copilot Auto-Analysis Initiated**
          
Copilot will analyze this workflow failure and provide:
- Root cause analysis
- Suggested fixes
- Code changes in PR form

**Checklist:**
- [ ] Analyze workflow logs
- [ ] Identify failing component
- [ ] Propose solution
- [ ] Create fix PR

ETA: 2-5 minutes
          """
          
          result = subprocess.run(
              [
                  "gh", "issue", "comment", str(issue_number),
                  "--body", comment_body
              ],
              capture_output=True,
              text=True,
              env={**os.environ, "GH_TOKEN": "${{ github.token }}", "GH_REPO": f"{owner}/{repo}"}
          )
          
          if result.returncode == 0:
              print("âœ… Added Copilot analysis comment")
          else:
              print(f"Note: {result.stderr}")
          
          PYTHON_SCRIPT
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ¤– Auto-Fix Agent Status"
          echo ""
          echo "**Workflow:** ${{ steps.workflow.outputs.workflow_name }}"
          echo "**Run:** #${{ steps.workflow.outputs.run_number }}"
          echo "**Errors found:** ${{ steps.logs.outputs.error_count }}"
          echo ""
          if [ "${{ steps.issue.outputs.issue_url }}" != "" ]; then
            echo "**âœ… Issue created:** ${{ steps.issue.outputs.issue_url }}"
            echo "**ðŸ¤– Copilot assigned for analysis**"
          else
            echo "âš ï¸ No issue created (may be in progress)"
          fi
          echo ""
          echo "### What happens next:
          echo "1. âœ… Issue created with error context"
          echo "2. ðŸ¤– Copilot analyzes workflow logs"
          echo "3. ðŸ“ Auto-fix PR created (if possible)"
          echo "4. ðŸ‘€ Manual review recommended"
