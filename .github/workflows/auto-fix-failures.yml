name: Auto-Fix Test Failures

on:
  workflow_run:
    workflows:
      - "Run Tests"
    types:
      - completed
    branches:
      - main
      - feature-*

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    name: Gemini Auto-Fix
    if: github.event.workflow_run.conclusion == 'failure'
    timeout-minutes: 20
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Download Test Logs
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          path: workflow-artifacts
        continue-on-error: true

      - name: Extract Error Information
        id: extract
        run: |
          python3 << 'EOF'
          import os
          import re
          from pathlib import Path
          
          # –ò—â–µ–º –ª–æ–≥–∏ —Ç–µ—Å—Ç–æ–≤
          error_info = []
          failed_tests = []
          error_messages = []
          
          for log_file in Path('workflow-artifacts').rglob('*.log'):
              try:
                  with open(log_file, 'r', encoding='utf-8', errors='ignore') as f:
                      content = f.read()
                      
                      # –ò—â–µ–º FAILED —Ç–µ—Å—Ç—ã
                      for match in re.finditer(r'FAILED (.*?) -', content):
                          failed_tests.append(match.group(1))
                      
                      # –ò—â–µ–º –æ—à–∏–±–∫–∏
                      for match in re.finditer(r'(AssertionError|ValueError|TypeError|AttributeError|ImportError)[:\s]+(.*?)(?=\n|$)', content):
                          error_messages.append(f"{match.group(1)}: {match.group(2)[:200]}")
                      
                      # –ò—â–µ–º —Ç—Ä–µ–π—Å–±–µ–∫–∏
                      traceback_matches = re.findall(r'(Traceback.*?)(?=\n[A-Z]|\nFAILED|$)', content, re.DOTALL)
                      for tb in traceback_matches[:3]:  # –ü–µ—Ä–≤—ã–µ 3 —Ç—Ä–µ–π—Å–±–µ–∫–∞
                          error_info.append(tb[:500])
              except Exception as e:
                  print(f"Error reading {log_file}: {e}")
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
          with open('error_analysis.txt', 'w') as f:
              f.write("FAILED TESTS:\n")
              f.write("\n".join(set(failed_tests[:5])) + "\n\n")
              
              f.write("ERROR MESSAGES:\n")
              f.write("\n".join(set(error_messages[:5])) + "\n\n")
              
              f.write("TRACEBACKS:\n")
              f.write("\n".join(error_info[:3]) + "\n")
          
          print(f"Extracted {len(failed_tests)} failed tests")
          print(f"Found {len(error_messages)} error messages")
          
          # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–∞—Ö
          with open('$GITHUB_OUTPUT', 'a') as f:
              f.write(f"failed_count={len(failed_tests)}\n")
              f.write(f"has_errors={len(error_messages) > 0}\n")
          
          EOF

      - name: Call Gemini CLI for Analysis
        if: steps.extract.outputs.has_errors == 'true' && env.GEMINI_API_KEY != ''
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          pip install -q google-generativeai
          
          python3 << 'EOF'
          import os
          import json
          import google.generativeai as genai
          
          api_key = os.getenv('GEMINI_API_KEY')
          genai.configure(api_key=api_key)
          
          # –ß–∏—Ç–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–∞—Ö
          with open('error_analysis.txt', 'r') as f:
              error_analysis = f.read()
          
          # –ß–∏—Ç–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
          code_files = []
          from pathlib import Path
          for py_file in Path('core').rglob('*.py'):
              if py_file.name not in ['__pycache__', '.pyc']:
                  try:
                      with open(py_file, 'r') as f:
                          code_files.append({
                              'path': str(py_file),
                              'content': f.read()[:1500]  # –ü–µ—Ä–≤—ã–µ 1500 —Å–∏–º–≤–æ–ª–æ–≤
                          })
                  except:
                      pass
          
          code_context = json.dumps(code_files[:5], indent=2)  # Top 5 files
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è Gemini
          prompt = f"""
You are an expert Python developer debugging test failures.

Analyze the following test failure and provide specific code fixes:

**Error Analysis:**
{error_analysis}

**Code Context (Top files):**
{code_context}

**Your Task:**
1. Identify root cause of failures
2. Provide EXACT code fixes (show before/after)
3. Specify which files to modify
4. Include line numbers where applicable
5. Be concise and actionable

Format your response as:
```
ROOT CAUSE:
[explanation]

FIXES:
1. File: [path]
   Line: [number]
   Before: [code]
   After: [code]
   Reason: [why]
```
"""
          
          model = genai.GenerativeModel('gemini-2.5-pro')
          response = model.generate_content(prompt)
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–Ω–∞–ª–∏–∑
          with open('gemini_fixes.md', 'w') as f:
              f.write(f"# Gemini Auto-Fix Analysis\n\n")
              f.write(f"Generated for: ${{ github.event.workflow_run.head_branch }}\n")
              f.write(f"Commit: ${{ github.event.workflow_run.head_commit.message }}\n\n")
              f.write(response.text)
          
          print("‚úÖ Gemini Analysis Complete")
          print(response.text)
          
          EOF
        continue-on-error: true

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -q -r requirements.txt
        continue-on-error: true

      - name: Auto-Apply Fixes
        if: hashFiles('gemini_fixes.md') != ''
        run: |
          python3 << 'EOF'
          import re
          from pathlib import Path
          
          with open('gemini_fixes.md', 'r') as f:
              content = f.read()
          
          # –ò—â–µ–º –±–ª–æ–∫–∏ —Å —Ñ–∏–∫—Å–∞–º–∏
          fix_pattern = r"File:\s*(.+?)\s*\n.*?Before:\s*```(.+?)```\s*After:\s*```(.+?)```"
          
          for match in re.finditer(fix_pattern, content, re.DOTALL):
              filepath = match.group(1).strip()
              before = match.group(2).strip()
              after = match.group(3).strip()
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
              if Path(filepath).exists():
                  try:
                      with open(filepath, 'r') as f:
                          file_content = f.read()
                      
                      # –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–∫—Å
                      if before in file_content:
                          new_content = file_content.replace(before, after)
                          with open(filepath, 'w') as f:
                              f.write(new_content)
                          print(f"‚úÖ Applied fix to {filepath}")
                      else:
                          print(f"‚ö†Ô∏è Could not find exact match in {filepath}")
                  except Exception as e:
                      print(f"‚ùå Error fixing {filepath}: {e}")
              else:
                  print(f"‚ö†Ô∏è File not found: {filepath}")
          
          EOF
        continue-on-error: true

      - name: Run Tests Again
        env:
          GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY || 'test-key-for-ci' }}
          PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY || 'test-key-for-ci' }}
        run: |
          pytest tests/ -v --tb=short -m "not slow" --maxfail=5 2>&1 | tee pytest-after-fix.log || true
        continue-on-error: true

      - name: Check if Tests Pass Now
        id: test-status
        run: |
          if grep -q "passed" pytest-after-fix.log; then
            echo "TESTS_FIXED=true" >> $GITHUB_OUTPUT
            grep "passed" pytest-after-fix.log
          else
            echo "TESTS_FIXED=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Create Fix Branch & PR
        if: steps.test-status.outputs.TESTS_FIXED == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');
            
            try {
              // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º git
              execSync('git config user.email "github-actions[bot]@github.com"');
              execSync('git config user.name "github-actions[bot]"');
              
              // –°–æ–∑–¥–∞—ë–º –≤–µ—Ç–∫—É
              const timestamp = new Date().getTime();
              const branchName = `gemini-auto-fix-${context.runId}`;
              
              execSync(`git checkout -b ${branchName}`);
              execSync('git add -A');
              execSync('git commit -m "ü§ñ Auto-fix: Gemini AI fixes test failures\n\nApplied fixes from Gemini CLI analysis to resolve failing tests."');
              execSync(`git push origin ${branchName}`);
              
              // –°–æ–∑–¥–∞—ë–º PR
              const geminiAnalysis = fs.readFileSync('gemini_fixes.md', 'utf8');
              const testLogs = fs.readFileSync('pytest-after-fix.log', 'utf8').slice(-500);
              
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ü§ñ [AUTO-FIX] Test failures fixed by Gemini AI',
                head: branchName,
                base: context.ref.replace('refs/heads/', ''),
                body: `## Automated Fix by Gemini AI\n\n### Analysis\n${geminiAnalysis}\n\n### Test Results After Fix\n\`\`\`\n${testLogs}\n\`\`\`\n\n---\n\n**Original Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}\n**Triggered by:** @${{ github.event.workflow_run.actor }}`,
                labels: ['ü§ñ auto-generated', '‚úÖ auto-fix', 'tests']
              });
              
              console.log(`‚úÖ PR Created: #${pr.data.number}`);
              
              // –û—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.data.number,
                body: `üöÄ **Gemini AI Auto-Fix Successful!**\n\nThe failing tests have been analyzed and fixed automatically.\nPlease review the changes and merge if everything looks good!`
              });
            } catch (error) {
              console.log(`‚ö†Ô∏è Error creating PR: ${error.message}`);
            }
        continue-on-error: true

      - name: Create Failure Issue
        if: steps.test-status.outputs.TESTS_FIXED == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const geminiAnalysis = fs.readFileSync('gemini_fixes.md', 'utf8').slice(0, 2000);
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üî¥ [NEEDS MANUAL FIX] Test failures - Gemini suggestions available`,
              body: `## Automated Analysis (Could Not Auto-Fix)\n\n${geminiAnalysis}\n\n### Next Steps\n- Review Gemini suggestions above\n- Apply changes manually\n- Re-run tests\n\n---\n**Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}`,
              labels: ['üî¥ manual-fix', 'bug', 'help wanted'],
              assignees: ['${{ github.event.workflow_run.actor }}']
            });
            
            console.log(`üìù Issue created: #${issue.data.number}`);
        continue-on-error: true

      - name: Upload Analysis Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gemini-auto-fix-${{ github.run_number }}
          path: |
            gemini_fixes.md
            error_analysis.txt
            pytest-after-fix.log
          retention-days: 7
        continue-on-error: true
