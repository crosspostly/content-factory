name: Qwen Token Auto-Refresh

on:
  schedule:
    # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 2 AM UTC (10 AM MSK)
    - cron: '0 2 * * *'
  workflow_dispatch:  # –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  refresh-token:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Refresh Qwen Access Token
        id: refresh
        env:
          QWEN_REFRESH_TOKEN: ${{ secrets.QWEN_REFRESH_TOKEN }}
          GH_TOKEN: ${{ github.token }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import requests
          import json
          import os
          from datetime import datetime, timedelta
          
          refresh_token = os.getenv('QWEN_REFRESH_TOKEN')
          
          if not refresh_token:
              print("‚ùå QWEN_REFRESH_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ Secrets!")
              print("üìù –î–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –≤ Settings ‚Üí Secrets:")
              print("   Name: QWEN_REFRESH_TOKEN")
              print("   Value: 1dxcdJ3uDRIPl5F0EEaB0un0lS1-dkEby3Hqb1z1qdSn4HWeUoa23jZKOkvJ_Bg4a7ijeR6TBOznPdJd1c1Wmg")
              exit(1)
          
          print("üîÑ –û–±–Ω–æ–≤–ª—è—é Qwen Access Token...")
          
          # –ó–∞–ø—Ä–æ—Å –∫ Qwen OAuth –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
          response = requests.post(
              "https://qwenlm.auth0.com/oauth/token",
              json={
                  "grant_type": "refresh_token",
                  "client_id": "NqOqg6X7O1OjN1l2vUqaEflnYF0xkW6q",  # –≠—Ç–æ –ø—É–±–ª–∏—á–Ω—ã–π ID –∏–∑ Qwen Code
                  "client_secret": "",  # –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
                  "refresh_token": refresh_token,
                  "scope": "offline_access"
              }
          )
          
          if response.status_code != 200:
              print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞: {response.status_code}")
              print(f"Response: {response.text}")
              
              # –ü–æ–ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π endpoint –¥–ª—è DashScope
              print("\nüìå –ü—ã—Ç–∞–µ–º—Å—è DashScope endpoint...")
              response = requests.post(
                  "https://dashscope.aliyuncs.com/oauth/token",
                  data={
                      "grant_type": "refresh_token",
                      "refresh_token": refresh_token
                  }
              )
              
              if response.status_code != 200:
                  print(f"‚ùå DashScope —Ç–∞–∫–∂–µ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª: {response.status_code}")
                  exit(1)
          
          data = response.json()
          new_access_token = data.get('access_token')
          new_refresh_token = data.get('refresh_token', refresh_token)  # Fallback to old one
          expires_in = data.get('expires_in', 3600)
          
          if not new_access_token:
              print(f"‚ùå –ù–µ –ø–æ–ª—É—á–µ–Ω –Ω–æ–≤—ã–π access_token!")
              print(f"Response: {data}")
              exit(1)
          
          print(f"‚úÖ –ü–æ–ª—É—á–µ–Ω –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω!")
          print(f"   –î–µ–π—Å—Ç–≤—É–µ—Ç {expires_in} —Å–µ–∫—É–Ω–¥ ({expires_in // 3600} —á–∞—Å–æ–≤)")
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è GitHub Secrets
          with open('/tmp/qwen_tokens.json', 'w') as f:
              json.dump({
                  'access_token': new_access_token,
                  'refresh_token': new_refresh_token,
                  'updated_at': datetime.now().isoformat(),
                  'expires_in': expires_in
              }, f, indent=2)
          
          # –í—ã–≤–æ–¥–∏–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"new_token={new_access_token}\n")
              f.write(f"new_refresh_token={new_refresh_token}\n")
              f.write(f"expires_in={expires_in}\n")
          
          PYTHON_SCRIPT
      
      - name: Update GitHub Secrets (via CLI)
        if: success()
        env:
          GH_TOKEN: ${{ github.token }}
          NEW_ACCESS_TOKEN: ${{ steps.refresh.outputs.new_token }}
          NEW_REFRESH_TOKEN: ${{ steps.refresh.outputs.new_refresh_token }}
        run: |
          # –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, GitHub API –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å Secrets –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ
          # –∏–∑ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
          # 
          # –í–∞—Ä–∏–∞–Ω—Ç—ã:
          # 1. –í—Ä—É—á–Ω—É—é —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω—ã
          # 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å GitHub CLI (—Ç—Ä–µ–±—É–µ—Ç push access)
          # 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Actions Secrets API (—Ç—Ä–µ–±—É–µ—Ç Personal Access Token)
          # 4. –•—Ä–∞–Ω–∏—Ç—å –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ workflow
          
          echo "\nüìå –ù–û–í–´–ô ACCESS TOKEN (—Å–∫–æ–ø–∏—Ä—É–π –≤ GitHub Secrets):"
          echo "================================"
          echo "$NEW_ACCESS_TOKEN"
          echo "================================"
          echo ""
          echo "üìå –ù–û–í–´–ô REFRESH TOKEN (—Å–∫–æ–ø–∏—Ä—É–π –≤ GitHub Secrets):"
          echo "================================"
          echo "$NEW_REFRESH_TOKEN"
          echo "================================"
      
      - name: Create Issue with new tokens
        if: success()
        env:
          GH_TOKEN: ${{ github.token }}
          NEW_ACCESS_TOKEN: ${{ steps.refresh.outputs.new_token }}
          EXPIRES_IN: ${{ steps.refresh.outputs.expires_in }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          import subprocess
          from datetime import datetime, timedelta
          
          new_token = os.getenv('NEW_ACCESS_TOKEN')
          expires_in = int(os.getenv('EXPIRES_IN', '3600'))
          expires_at = (datetime.now() + timedelta(seconds=expires_in)).isoformat()
          
          issue_body = f"""## üîê Qwen Token Refreshed

‚úÖ Access Token —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω!

### –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- **–í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** {datetime.now().isoformat()}
- **–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ:** {expires_at}
- **–î–µ–π—Å—Ç–≤—É–µ—Ç:** {expires_in} —Å–µ–∫—É–Ω–¥ ({expires_in // 3600} —á–∞—Å–æ–≤)

### ‚ö†Ô∏è –í–ê–ñ–ù–û!

**GitHub API –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å Secrets –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ** –∏–∑ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

–ù–æ–≤—ã–π —Ç–æ–∫–µ–Ω –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ log –≤—ã—à–µ.

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å:

1. –û—Ç–∫—Ä–æ–π:
   https://github.com/${{ github.repository }}/settings/secrets/actions

2. –û–±–Ω–æ–≤–∏ `QWEN_ACCESS_TOKEN`:
   ```
   {new_token}
   ```

3. –û–±–Ω–æ–≤–∏ `QWEN_REFRESH_TOKEN`:
   –°–∫–æ–ø–∏—Ä—É–π –∏–∑ –ª–æ–≥–∞ –≤—ã—à–µ

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Personal Access Token

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é:
1. –°–æ–∑–¥–∞–π Personal Access Token (Settings ‚Üí Developer settings)
2. –î–æ–±–∞–≤—å –µ–≥–æ –∫–∞–∫ Secret: `GH_PAT`
3. –ò—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Secrets —á–µ—Ä–µ–∑ GitHub CLI

---

*–≠—Ç–æ—Ç workflow –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 2 AM UTC*
"""
          
          # –°–æ–∑–¥–∞—ë–º issue —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –Ω–æ–≤–æ–º —Ç–æ–∫–µ–Ω–µ
          result = subprocess.run(
              [
                  'gh', 'issue', 'create',
                  '--title', 'üîê Qwen Token Refreshed',
                  '--body', issue_body,
                  '--label', 'qwen,token-refresh,automation'
              ],
              capture_output=True,
              text=True,
              env={**os.environ, 'GH_TOKEN': os.getenv('GH_TOKEN')}
          )
          
          if result.returncode == 0:
              print(f"‚úÖ Created issue: {result.stdout.strip()}")
          else:
              print(f"‚ö†Ô∏è Could not create issue: {result.stderr}")
          
          PYTHON_SCRIPT
      
      - name: Summary
        if: always()
        run: |
          echo "## üîÑ Qwen Token Refresh Summary"
          echo ""
          echo "**Status:** ${{ job.status }}"
          echo "**Access Token:** ${{ steps.refresh.outputs.new_token != '' && '‚úÖ Updated' || '‚ùå Failed' }}"
          echo "**Expires in:** ${{ steps.refresh.outputs.expires_in }} seconds"
          echo ""
          echo "### üìù Reminder"
          echo "Manually update GitHub Secrets with new tokens:"
          echo "- `QWEN_ACCESS_TOKEN`: ${{ steps.refresh.outputs.new_token }}"
          echo "- `QWEN_REFRESH_TOKEN`: ${{ steps.refresh.outputs.new_refresh_token }}"
