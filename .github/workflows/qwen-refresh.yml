name: Qwen Token Auto-Refresh

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  refresh:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Refresh Qwen Token
        env:
          REFRESH_TOKEN: ${{ secrets.QWEN_REFRESH_TOKEN }}
        run: |
          pip install requests
          python3 << 'EOF'
          import requests, json, os
          from datetime import datetime
          
          refresh_token = os.getenv('REFRESH_TOKEN')
          if not refresh_token:
              print("ERROR: QWEN_REFRESH_TOKEN not set")
              exit(1)
          
          print("Refreshing Qwen token via auth.qwenlm.com...")
          
          response = requests.post(
              "https://auth.qwenlm.com/oauth/token",
              json={"grant_type": "refresh_token", "refresh_token": refresh_token}
          )
          
          if response.status_code != 200:
              print(f"Failed: {response.status_code}")
              print(response.text)
              exit(1)
          
          data = response.json()
          print(f"SUCCESS! New token expires in {data.get('expires_in', 3600)} seconds")
          
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"new_token={data['access_token']}\n")
          EOF
